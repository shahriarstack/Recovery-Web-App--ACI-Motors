<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recovery Intelligence Platform</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#ecfdf5', // Soft Mint
                            100: '#d1fae5', // Pale Green
                            500: '#10b981', // Emerald (Primary)
                            600: '#059669', // Darker Emerald
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9'
                        }
                    },
                    animation: {
                        blob: "blob 7s infinite",
                    },
                    keyframes: {
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" },
                        },
                    },
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s;
            background-color: #f8fafc;
            /* Premium ambient gradient for light mode */
            background-image:
                radial-gradient(at 0% 0%, hsla(160, 100%, 74%, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(210, 100%, 74%, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .dark body {
            background-color: #0f172a;
            /* Premium deeper ambient dark mode gradient */
            background-image:
                radial-gradient(at 0% 0%, hsla(160, 100%, 20%, 0.2) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(210, 100%, 20%, 0.2) 0px, transparent 50%);
            background-attachment: fixed;
        }

        /* Advanced Modern Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass-panel:hover {
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 1);
        }

        .dark .glass-panel:hover {
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Floating particles behind app */
        .particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 50%;
            animation: float-up linear infinite;
        }

        .dark .particle {
            background: rgba(16, 185, 129, 0.15);
        }

        @keyframes float-up {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(-10vh) scale(1.5);
                opacity: 0;
            }
        }

        /* Smooth Animations */
        @keyframes smoothSlideUp {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.97);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-entry {
            animation: smoothSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Animation Delays */
        .animation-delay-2000 {
            animation-delay: 2s;
        }

        .animation-delay-4000 {
            animation-delay: 4s;
        }

        /* Interactive Elements */
        .hover-lift {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .dark .hover-lift:hover {
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.3);
        }

        .hover-lift:active {
            transform: translateY(0) scale(0.98);
        }

        /* Custom Scrollbar Premium */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.9);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.6);
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(71, 85, 105, 0.9);
        }

        /* Sidebar Transition */
        #sidebar {
            z-index: 50;
        }

        #sidebar-overlay {
            z-index: 40;
        }

        /* CREATIVE LOADER STYLE */
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite, glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px -5px #10b981;
            }

            to {
                box-shadow: 0 0 20px 0px #10b981;
            }
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* FLOATING ACTION DOCK */
        .floating-dock {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 60;
        }

        .floating-dock.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-dark-bg dark:text-dark-text min-h-screen flex flex-col relative z-0">

    <!-- PARTICLES BACKGROUND -->
    <div class="particles-bg" id="particles-bg"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('particles-bg');
            if (container) {
                for (let i = 0; i < 30; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    const size = Math.random() * 6 + 3; // 3px to 9px
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';
                    p.style.left = Math.random() * 100 + 'vw';
                    p.style.animationDuration = (Math.random() * 10 + 10) + 's';
                    p.style.animationDelay = (Math.random() * 10) + 's';
                    container.appendChild(p);
                }
            }
        });
    </script>

    <!-- GLOBAL LOADING OVERLAY -->
    <div id="global-loader"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-white/40 dark:bg-slate-900/40 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div
            class="glass-panel px-8 py-6 rounded-2xl shadow-2xl flex flex-col items-center transform scale-100 transition-transform duration-300">
            <div class="loader-spinner mb-3"></div>
            <p class="text-xs font-bold text-brand-600 dark:text-brand-400 tracking-widest uppercase animate-pulse">
                Processing</p>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-view"
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 animate-fade-in overflow-hidden">
        <!-- New Creative Low-Poly Style Background (Green Theme #53db8c) -->
        <div class="absolute inset-0 z-0 overflow-hidden">
            <!-- Base Gradient: Deep Forest Green -> #53db8c -> Pale Mint -->
            <div class="absolute inset-0 bg-gradient-to-br from-[#064e3b] via-[#53db8c] to-[#d1fae5]"></div>

            <!-- Geometric Facet Overlays to mimic Low Poly -->
            <div class="absolute top-0 left-0 w-full h-full mix-blend-overlay opacity-50">
                <!-- Large Diagonal Slice -->
                <div class="absolute top-0 left-0 w-full h-full bg-white/10"
                    style="clip-path: polygon(0 0, 100% 0, 50% 100%);"></div>
                <!-- Bottom Right Highlight (using #53db8c tint) -->
                <div class="absolute bottom-0 right-0 w-2/3 h-full bg-[#53db8c]/30"
                    style="clip-path: polygon(0 100%, 100% 100%, 100% 0);"></div>
                <!-- Top Left Shadow -->
                <div class="absolute top-0 left-0 w-2/3 h-full bg-black/10"
                    style="clip-path: polygon(0 0, 100% 0, 0 100%);"></div>
                <!-- Center Diamond tint -->
                <div class="absolute top-1/4 left-1/4 w-1/2 h-1/2 bg-white/10 rotate-45 backdrop-blur-sm"></div>
            </div>

            <!-- Subtle Texture/Noise -->
            <div class="absolute inset-0 opacity-[0.03]"
                style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22/%3E%3C/svg%3E');">
            </div>
        </div>

        <div class="relative z-10 w-full max-w-md p-6 animate-entry">
            <!-- UPDATED LOGIN CARD with #53db8c Theme -->
            <div class="glass-panel p-10 rounded-3xl backdrop-blur-xl transition-all duration-300 relative overflow-hidden"
                style="background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 60%, rgba(83, 219, 140, 0.15) 100%); 
                        box-shadow: 0 25px 50px -12px rgba(83, 219, 140, 0.3);
                        border: 1px solid rgba(83, 219, 140, 0.3);">

                <!-- Dark mode override via class for bg, inline style handles light mode specific gradient structure mostly -->
                <div class="absolute inset-0 bg-slate-800/90 dark:block hidden z-[-1]"
                    style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.95) 0%, rgba(30, 41, 59, 0.85) 60%, rgba(83, 219, 140, 0.15) 100%);">
                </div>

                <div class="text-center mb-10">
                    <!-- ACI MOTORS LOGO -->
                    <img src="https://i.ibb.co.com/cshLMZ7/aci-motors-seeklogo.png" alt="ACI Motors"
                        class="h-10 w-auto object-contain mx-auto mb-6 hover:scale-105 transition-transform duration-300">

                    <h1 class="text-3xl font-bold text-slate-800 dark:text-white tracking-tight mb-2">Recovery Companion
                    </h1>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">Welcome back</p>
                </div>

                <!-- CREATIVE TABS -->
                <div class="relative p-1 rounded-xl bg-slate-100 dark:bg-slate-700/50 flex mb-8">
                    <div id="login-tab-indicator"
                        class="absolute left-1 top-1 bottom-1 w-[calc(50%-4px)] bg-white dark:bg-slate-600 rounded-lg shadow-sm transition-all duration-300 ease-out transform translate-x-0">
                    </div>
                    <button type="button" onclick="UI.setLoginTab('officer')" id="btn-officer"
                        class="relative z-10 w-1/2 py-2 text-sm font-bold text-[#53db8c] transition-colors duration-300 focus:outline-none">Officer</button>
                    <button type="button" onclick="UI.setLoginTab('admin')" id="btn-admin"
                        class="relative z-10 w-1/2 py-2 text-sm font-medium text-slate-500 dark:text-slate-400 transition-colors duration-300 focus:outline-none">Admin</button>
                </div>

                <form id="login-form" class="space-y-5">
                    <div>
                        <label
                            class="block text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2 ml-1"
                            id="lbl-username">Select Territory</label>
                        <div class="relative group">
                            <span
                                class="absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400 group-focus-within:text-[#53db8c] transition-colors pointer-events-none z-10">
                                <i class="fa-regular fa-user"></i>
                            </span>

                            <!-- Admin Input -->
                            <input type="text" id="username"
                                class="hidden w-full pl-11 pr-4 py-3.5 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-[#53db8c]/20 focus:border-[#53db8c] outline-none transition-all text-slate-800 dark:text-white placeholder-slate-400"
                                placeholder="Admin Username">

                            <!-- Officer Dropdown -->
                            <select id="officer-select"
                                class="w-full pl-11 pr-10 py-3.5 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-[#53db8c]/20 focus:border-[#53db8c] outline-none transition-all appearance-none cursor-pointer text-slate-800 dark:text-white">
                                <option value="">Select Territory</option>
                                <!-- Populated via JS -->
                            </select>
                            <div id="officer-dropdown-arrow"
                                class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none text-slate-400">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2 ml-1"
                            id="lbl-password">Employee ID</label>
                        <div class="relative group">
                            <span
                                class="absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400 group-focus-within:text-[#53db8c] transition-colors">
                                <i class="fa-solid fa-lock-open"></i>
                            </span>
                            <input type="password" id="password"
                                class="w-full pl-11 pr-4 py-3.5 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-[#53db8c]/20 focus:border-[#53db8c] outline-none transition-all text-slate-800 dark:text-white placeholder-slate-400"
                                placeholder="••••••••" required>
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-[0.98] shadow-lg flex justify-center items-center group"
                        style="background: linear-gradient(90deg, #53db8c 0%, #10b981 100%); box-shadow: 0 10px 15px -3px rgba(83, 219, 140, 0.4);">
                        <span class="mr-2">Sign In</span>
                        <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </form>

                <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700/50 text-center">
                    <p class="text-xs text-slate-400">
                        <span class="font-medium text-slate-500 dark:text-slate-300">Demo Access:</span><br>
                        Admin: admin / 1234 &nbsp;|&nbsp; Officer: territory1 / 1001
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP LAYOUT (Hidden by default) -->
    <div id="app-layout" class="hidden flex-1 flex overflow-hidden relative">

        <!-- SIDEBAR OVERLAY -->
        <div id="sidebar-overlay" onclick="UI.toggleSidebar()"
            class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity duration-300 opacity-0"></div>

        <!-- SIDEBAR (DRAWER STYLE) -->
        <aside
            class="w-64 bg-white dark:bg-dark-card border-r border-slate-200 dark:border-slate-700 flex flex-col transition-transform duration-300 transform -translate-x-full fixed z-50 h-full shadow-2xl"
            id="sidebar">
            <div class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-700">
                <!-- ACI MOTORS BRANDING IN SIDEBAR -->
                <img src="https://i.ibb.co.com/cshLMZ7/aci-motors-seeklogo.png" alt="ACI Motors"
                    class="h-10 object-contain hover:scale-105 transition-transform">
                <button onclick="UI.toggleSidebar()" class="ml-auto md:hidden text-slate-400 hover:text-brand-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <div id="admin-nav" class="hidden space-y-1">
                    <p class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Management</p>
                    <a href="#" onclick="Router.navigate('admin-dashboard')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-brand-50 text-brand-700 dark:bg-slate-800 dark:text-brand-400 transition-all duration-200">
                        <i class="fa-solid fa-gauge mr-3 w-5"></i> Dashboard
                    </a>
                    <!-- Data Entry -->
                    <a href="#" onclick="Router.navigate('admin-data-entry')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-table-list mr-3 w-5"></i> Data Entry
                    </a>
                    <!-- User Management -->
                    <a href="#" onclick="Router.navigate('admin-users')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-users-gear mr-3 w-5"></i> User Management
                    </a>
                    <!-- NEW ADMIN TAB -->
                    <a href="#" onclick="Router.navigate('admin-offroad')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-car-burst mr-3 w-5"></i> Offroad Monitor
                    </a>
                    <!-- NEW PROJECTION MONITOR TAB -->
                    <a href="#" onclick="Router.navigate('admin-projections')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-stopwatch mr-3 w-5"></i> Projection Monitor
                    </a>
                    <!-- SETTLEMENTS TAB -->
                    <a href="#" onclick="Router.navigate('admin-settlements')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-file-signature mr-3 w-5"></i> Settlement Vault
                    </a>
                    <!-- NEW ADMIN HISTORY TAB -->
                    <a href="#" onclick="Router.navigate('admin-history')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-clock-rotate-left mr-3 w-5"></i> Global Collections
                    </a>
                    <!-- NEW ADMIN VEHICLE PERFORMANCE TAB -->
                    <a href="#" onclick="Router.navigate('admin-vehicle-perf')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-truck-fast mr-3 w-5"></i> Vehicle Performance
                    </a>
                </div>

                <div id="officer-nav" class="hidden space-y-1">
                    <p class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Operations</p>
                    <a href="#" onclick="Router.navigate('officer-dashboard')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-brand-50 text-brand-700 dark:bg-slate-800 dark:text-brand-400 transition-all duration-200">
                        <i class="fa-solid fa-gauge mr-3 w-5"></i> My Dashboard
                    </a>
                    <a href="#" onclick="Router.navigate('officer-projection')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-regular fa-calendar-check mr-3 w-5"></i> Morning Projection
                    </a>
                    <a href="#" onclick="Router.navigate('officer-collection')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-money-bill-transfer mr-3 w-5"></i> Collection Entry
                    </a>
                    <a href="#" onclick="Router.navigate('officer-offroad')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-triangle-exclamation mr-3 w-5"></i> Offroad Tracker
                    </a>
                    <!-- OFFICER SETTLEMENTS -->
                    <a href="#" onclick="Router.navigate('officer-settlements')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-file-contract mr-3 w-5"></i> Settlements
                    </a>
                    <!-- OFFICER HISTORY -->
                    <a href="#" onclick="Router.navigate('officer-history')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-clock-rotate-left mr-3 w-5"></i> Collection History
                    </a>
                    <!-- NEW OFFICER VEHICLE ANALYTICS TAB -->
                    <a href="#" onclick="Router.navigate('officer-analytics')"
                        class="nav-item flex items-center px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-magnifying-glass-chart mr-3 w-5"></i> Vehicle Analytics
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700">
                <!-- LOGOUT BUTTON -->
                <button onclick="Auth.logout()"
                    class="flex items-center w-full px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all duration-200 group">
                    <i
                        class="fa-solid fa-arrow-right-from-bracket mr-3 group-hover:translate-x-1 transition-transform"></i>
                    Logout
                </button>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative w-full">

            <!-- TOP BAR -->
            <header
                class="h-16 bg-white/80 dark:bg-dark-card/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 z-10 sticky top-0">
                <button class="text-slate-500 hover:text-brand-600 transition-colors mr-4" onclick="UI.toggleSidebar()">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>

                <div class="flex items-center space-x-4 ml-auto">
                    <!-- Date Filter Mock -->
                    <div
                        class="hidden sm:flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-1.5 text-sm transition-colors">
                        <i class="fa-regular fa-calendar text-slate-400 mr-2"></i>
                        <span id="current-date-display" class="font-medium"></span>
                    </div>

                    <!-- Dark Mode Toggle -->
                    <button onclick="UI.toggleDarkMode()"
                        class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <i class="fa-solid fa-moon dark:hidden text-slate-600"></i>
                        <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
                    </button>

                    <!-- User Profile -->
                    <div class="flex items-center pl-4 border-l border-slate-200 dark:border-slate-700">
                        <div
                            class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold text-sm mr-2 hover-lift cursor-default">
                            <span id="user-avatar">A</span>
                        </div>
                        <span id="user-name" class="text-sm font-medium hidden sm:block">Admin</span>
                    </div>
                </div>
            </header>

            <!-- SCROLLABLE CONTENT -->
            <div id="content-area"
                class="flex-1 overflow-y-auto p-6 bg-slate-50 dark:bg-dark-bg scroll-smooth flex flex-col">

                <!-- DYNAMIC VIEWS CONTAINER -->
                <div id="views-container" class="flex-1">
                    <!-- Views will be injected here via JS -->
                </div>

                <!-- FOOTER / COPYRIGHT -->
                <footer
                    class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700/50 text-center select-none pb-4">
                    <p
                        class="text-[10px] font-bold tracking-[0.2em] text-slate-400 dark:text-slate-500 uppercase transition-colors hover:text-brand-600 dark:hover:text-brand-400 cursor-default mb-1">
                        ACI Motors @2026
                    </p>
                    <p class="text-[10px] text-slate-400 dark:text-slate-500 font-medium group cursor-default">
                        crafted by <span
                            class="bg-gradient-to-r from-brand-500 to-blue-500 bg-clip-text text-transparent font-bold inline-block hover:scale-105 transition-transform duration-300">Shahriar</span>
                    </p>
                </footer>

            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="generic-modal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content"
            class="bg-white dark:bg-dark-card rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all scale-95 opacity-0 duration-300">
            <!-- Content injected via JS -->
        </div>
    </div>

    <!-- SCRIPT SECTION -->
    <script>
        /**
         * 1. DATA LAYER
         */
        const Store = {
            cache: null,
            apiUrl: '/api',

            async init() {
                try {
                    const res = await fetch(`${this.apiUrl}/db`);
                    const data = await res.json();

                    if (data.error) {
                        console.error("Backend Error:", data.error);
                        alert("Database error: " + data.error + "\nMake sure the database schema is initialized.");
                        return null;
                    }

                    // If DB is empty (based on territories), seed it
                    if (data.territories && data.territories.length === 0) {
                        console.log("Database empty, seeding initial data...");
                        await this.seed();
                        return await this.init();
                    }

                    this.cache = data;
                    return data;
                } catch (err) {
                    console.error("Failed to connect to Neon Backend:", err);
                    alert("Database connection failed. Make sure the backend server (node server.js) is running on port 3000.");
                }
            },

            async seed() {
                const rawTerritories = [
                    { part: 'A', name: 'Bogura' }, { part: 'A', name: 'Chapainawabgonj' }, { part: 'A', name: 'Dinajpur' },
                    { part: 'A', name: 'Natore' }, { part: 'A', name: 'Rajshahi' }, { part: 'A', name: 'Rangpur' },
                    { part: 'A', name: 'Nilphamari' }, { part: 'A', name: 'Jashore' }, { part: 'A', name: 'Kushtia' },
                    { part: 'A', name: 'Khulna' }, { part: 'A', name: 'Manikganj' }, { part: 'A', name: 'Munshiganj 1' },
                    { part: 'A', name: 'Munshiganj-2' }, { part: 'A', name: 'Narayanganj' }, { part: 'A', name: 'Narshingdi' },
                    { part: 'A', name: 'Sirajganj' }, { part: 'A', name: 'Savar' }, { part: 'A', name: 'Tongi' },
                    { part: 'A', name: 'Gazipur' }, { part: 'A', name: 'Dhaka' }, { part: 'A', name: 'Head Office' },
                    { part: 'B', name: 'Barguna' }, { part: 'B', name: 'Barishal' }, { part: 'B', name: 'Brahmanaria' },
                    { part: 'B', name: 'Chandpur-1' }, { part: 'B', name: 'Chandpur-2' }, { part: 'B', name: 'Chattogram North' },
                    { part: 'B', name: 'Chattogram South' }, { part: 'B', name: "Cox'sBazar" }, { part: 'B', name: 'Cumilla-1' },
                    { part: 'B', name: 'Cumilla-2' }, { part: 'B', name: 'Faridpur' }, { part: 'B', name: 'Feni' },
                    { part: 'B', name: 'Gopalganj' }, { part: 'B', name: 'Hobiganj' }, { part: 'B', name: 'Jamalpur' },
                    { part: 'B', name: 'Kishoreganj' }, { part: 'B', name: 'Laxmipur' }, { part: 'B', name: 'Mymensingh' },
                    { part: 'B', name: 'Netrokona' }, { part: 'B', name: 'Noakhali-1' }, { part: 'B', name: 'Noakhali-2' },
                    { part: 'B', name: 'Sylhet' }, { part: 'B', name: 'Tangail' }
                ];

                const territories = rawTerritories.map((t) => ({
                    id: t.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase(),
                    name: t.name,
                    part: t.part,
                    officer: t.name
                }));

                const users = [
                    { username: 'admin', officerName: 'System Admin', role: 'admin', password: '1234' },
                    ...territories.map(t => ({
                        username: t.name,
                        officerName: `${t.name} Officer`,
                        role: 'officer',
                        password: '1234',
                        territoryId: t.id
                    }))
                ];

                await fetch(`${this.apiUrl}/sync-targets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ territories, targets: [] })
                });

                await fetch(`${this.apiUrl}/sync-users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ users })
                });
            },

            get() {
                return this.cache;
            },

            async update(collection, item) {
                // Remove redundant property if it's new
                if (String(item.id).startsWith('new_')) delete item.id;

                const res = await fetch(`${this.apiUrl}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ collection, item })
                });
                const updatedItem = await res.json();

                // Update local cache for performance
                const idx = this.cache[collection].findIndex(x => x.id === updatedItem.id);
                if (idx !== -1) this.cache[collection][idx] = updatedItem;
                else this.cache[collection].push(updatedItem);

                return updatedItem;
            },

            async delete(collection, id) {
                await fetch(`${this.apiUrl}/delete`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ collection, id })
                });
                this.cache[collection] = this.cache[collection].filter(x => x.id !== id);
            },

            async deleteMany(collection, ids) {
                for (const id of ids) {
                    await this.delete(collection, id);
                }
            }
        };

        /**
         * 2. CALCULATION ENGINE
         */
        const Calc = {
            getMetrics(territoryId = null) {
                const db = Store.get();
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const currentMonth = todayStr.slice(0, 7);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                let collections = db.collections.filter(c => c.date.startsWith(currentMonth));
                let targets = db.targets.filter(t => t.month === currentMonth);
                let projections = db.projections.filter(p => p.date.startsWith(currentMonth));

                if (territoryId) {
                    collections = collections.filter(c => c.territoryId === territoryId);
                    targets = targets.filter(t => t.territoryId === territoryId);
                    projections = projections.filter(p => p.territoryId === territoryId);
                }

                const targetAmt = targets.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                const targetFiles = targets.reduce((sum, t) => sum + (parseInt(t.files) || 0), 0);
                const lmNpTargetAmt = targets.reduce((sum, t) => sum + (parseFloat(t.lmNpTargetAmount) || 0), 0);
                const lmNpTargetFiles = targets.reduce((sum, t) => sum + (parseInt(t.lmNpTargetFiles) || 0), 0);

                const mtdColl = collections.reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
                const uniquePaidCodes = new Set(collections.map(c => c.customerCode)).size;
                const tillDateNonPayFiles = Math.max(0, targetFiles - uniquePaidCodes);

                const mtdLmNpColl = collections.filter(c => c.isLmNp).reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
                const mtdLmNpFiles = new Set(collections.filter(c => c.isLmNp).map(c => c.customerCode)).size;

                const mtdProjRegular = projections.reduce((sum, p) => sum + (parseFloat(p.regularAmount) || parseFloat(p.amount) || 0), 0);
                const mtdProjAdvance = projections.reduce((sum, p) => sum + (parseFloat(p.advanceAmount) || 0), 0);
                const mtdProjTotal = mtdProjRegular + mtdProjAdvance;
                const mtdProjFiles = projections.reduce((sum, p) => sum + (parseInt(p.fileCount) || 0), 0);

                const yestProj = projections.find(p => p.date === yesterdayStr) || {};
                const yestProjAmt = (parseFloat(yestProj.regularAmount) || 0) + (parseFloat(yestProj.advanceAmount) || 0) + (parseFloat(yestProj.amount) || 0);
                const yestProjFiles = parseInt(yestProj.fileCount) || 0;

                const yestCollEntries = collections.filter(c => c.date === yesterdayStr);
                const yestCollAmt = yestCollEntries.reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
                const yestCollFiles = new Set(yestCollEntries.map(c => c.customerCode)).size;

                const todayProjEntry = projections.find(p => p.date === todayStr);
                const todayProj = todayProjEntry ? (parseFloat(todayProjEntry.regularAmount) || 0) + (parseFloat(todayProjEntry.advanceAmount) || 0) : 0;
                const todayColl = collections.filter(c => c.date === todayStr).reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);

                const achievement = targetAmt > 0 ? (mtdColl / targetAmt) * 100 : 0;
                const tillDayAchievement = mtdProjRegular > 0 ? (mtdColl / mtdProjRegular) * 100 : 0;
                const lmNpRecPct = lmNpTargetAmt > 0 ? (mtdLmNpColl / lmNpTargetAmt) * 100 : 0;
                const cureRate = targetFiles > 0 ? (uniquePaidCodes / targetFiles) * 100 : 0;

                let projAcc = 0;
                if (todayProj > 0) {
                    const diff = Math.abs(todayProj - todayColl);
                    projAcc = Math.max(0, (1 - (diff / todayProj)) * 100);
                } else if (todayColl > 0 && todayProj === 0) {
                    projAcc = 0;
                } else {
                    projAcc = 100;
                }

                const now = new Date();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const dayOfMonth = now.getDate();
                const remainingAmt = Math.max(0, targetAmt - mtdColl);
                const daysLeft = daysInMonth - dayOfMonth;
                const rdrr = daysLeft > 0 ? remainingAmt / daysLeft : remainingAmt;

                const rpi = (achievement * 0.4) + (projAcc * 0.2) + (lmNpRecPct * 0.2) + (cureRate * 0.2);

                return {
                    targetAmt, targetFiles,
                    mtdColl, todayColl, remainingAmt, rdrr,
                    achievement: achievement.toFixed(1),
                    lmNpRecPct: lmNpRecPct.toFixed(1),
                    cureRate: cureRate.toFixed(1),
                    projAcc: projAcc.toFixed(1),
                    rpi: rpi.toFixed(1),
                    uniquePaidCodes,
                    tillDateNonPayFiles,
                    mtdProjRegular, mtdProjAdvance, mtdProjTotal, mtdProjFiles,
                    tillDayAchievement: tillDayAchievement.toFixed(1),
                    yestProjAmt, yestProjFiles, yestCollAmt, yestCollFiles,
                    lmNpTargetAmt, lmNpTargetFiles, mtdLmNpColl, mtdLmNpFiles,
                    todayProj,
                    rawCollections: collections,
                    rawTargets: targets
                };
            },

            getRPIColor(score) {
                if (score >= 90) return 'text-green-500';
                if (score >= 70) return 'text-yellow-500';
                return 'text-red-500';
            },

            getRPIBg(score) {
                if (score >= 90) return 'bg-green-100 dark:bg-green-900/30 border-green-200';
                if (score >= 70) return 'bg-yellow-100 dark:bg-yellow-900/30 border-yellow-200';
                return 'bg-red-100 dark:bg-red-900/30 border-red-200';
            }
        };

        /**
         * 3. AUTHENTICATION LAYER
         */
        const Auth = {
            currentUser: null,

            async login(username, password, requiredRole = 'officer') {
                UI.toggleLoader(true);
                try {
                    const db = await Store.init();
                    if (!db) return;

                    // Username acts as Territory for officer, Password acts as Employee ID
                    const user = db.users.find(u => u.username === username && u.password === password);

                    if (user) {
                        if (user.role !== requiredRole) {
                            alert(`Access Denied: You are trying to login as ${user.role} from the ${requiredRole === 'admin' ? 'Admin' : 'Officer'} tab.`);
                            UI.toggleLoader(false);
                            return;
                        }
                        this.currentUser = user;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        UI.initApp();
                    } else {
                        alert('Invalid credentials');
                    }
                } finally {
                    UI.toggleLoader(false);
                }
            },

            async checkSession() {
                const stored = localStorage.getItem('currentUser');
                if (stored) {
                    this.currentUser = JSON.parse(stored);
                    await Store.init();
                    UI.initApp();
                }
            },

            logout() {
                this.currentUser = null;
                localStorage.removeItem('currentUser');
                location.reload();
            }
        };

        /**
         * 4. UI RENDERING & LOGIC
         */
        const Router = {
            navigate(viewId) {
                const container = document.getElementById('views-container');
                container.innerHTML = '';

                // Auto hide sidebar on mobile/desktop selection
                UI.closeSidebar();

                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('bg-brand-50', 'text-brand-700', 'dark:bg-slate-800', 'dark:text-brand-400');
                    el.classList.add('text-slate-600', 'dark:text-slate-300');
                });

                if (viewId === 'admin-dashboard') UI.renderAdminDashboard();
                else if (viewId === 'admin-data-entry') UI.renderDataEntry();
                else if (viewId === 'admin-users') UI.renderUserManagement();
                else if (viewId === 'admin-offroad') UI.renderAdminOffroadView();
                else if (viewId === 'admin-settlements') UI.renderAdminSettlementsView();
                else if (viewId === 'admin-history') UI.renderAdminHistory();
                else if (viewId === 'admin-vehicle-perf') UI.renderAdminVehiclePerf();
                else if (viewId === 'admin-projections') UI.renderAdminProjections();
                else if (viewId === 'officer-dashboard') UI.renderOfficerDashboard();
                else if (viewId === 'officer-projection') UI.renderProjectionForm();
                else if (viewId === 'officer-collection') UI.renderCollectionForm();
                else if (viewId === 'officer-offroad') UI.renderOfficerOffroadTracker();
                else if (viewId === 'officer-settlements') UI.renderOfficerSettlementsView();
                else if (viewId === 'officer-history') UI.renderOfficerHistory();
                else if (viewId === 'officer-analytics') UI.renderOfficerVehicleAnalytics();
            },
        };

        const UI = {
            charts: {},
            currentLoginRole: 'officer',

            // --- LOADER ---
            toggleLoader(show) {
                const loader = document.getElementById('global-loader');
                if (show) {
                    loader.classList.remove('hidden');
                    void loader.offsetWidth;
                    loader.classList.remove('opacity-0');
                } else {
                    loader.classList.add('opacity-0');
                    setTimeout(() => {
                        loader.classList.add('hidden');
                    }, 300);
                }
            },

            setLoginTab(role) {
                this.currentLoginRole = role;
                const indicator = document.getElementById('login-tab-indicator');
                const btnOfficer = document.getElementById('btn-officer');
                const btnAdmin = document.getElementById('btn-admin');
                const lblUsername = document.getElementById('lbl-username');
                const lblPassword = document.getElementById('lbl-password');
                const inpUsername = document.getElementById('username');
                const selOfficer = document.getElementById('officer-select');
                const arrow = document.getElementById('officer-dropdown-arrow');

                if (role === 'officer') {
                    indicator.classList.remove('translate-x-[100%]', 'translate-x-full');
                    indicator.classList.add('translate-x-0');

                    btnOfficer.classList.add('text-[#53db8c]', 'font-bold');
                    btnOfficer.classList.remove('text-slate-500', 'dark:text-slate-400', 'font-medium');
                    btnAdmin.classList.remove('text-[#53db8c]', 'font-bold');
                    btnAdmin.classList.add('text-slate-500', 'dark:text-slate-400', 'font-medium');

                    lblUsername.innerText = 'Select Territory';
                    lblPassword.innerText = 'Employee ID';
                    inpUsername.classList.add('hidden');
                    selOfficer.classList.remove('hidden');
                    arrow.classList.remove('hidden');
                    this.populateLoginDropdown();
                } else {
                    indicator.classList.remove('translate-x-0');
                    indicator.classList.add('translate-x-[102%]');

                    btnAdmin.classList.add('text-[#53db8c]', 'font-bold');
                    btnAdmin.classList.remove('text-slate-500', 'dark:text-slate-400', 'font-medium');
                    btnOfficer.classList.remove('text-[#53db8c]', 'font-bold');
                    btnOfficer.classList.add('text-slate-500', 'dark:text-slate-400', 'font-medium');

                    lblUsername.innerText = 'Admin Username';
                    lblPassword.innerText = 'Password';
                    inpUsername.classList.remove('hidden');
                    selOfficer.classList.add('hidden');
                    arrow.classList.add('hidden');
                    inpUsername.placeholder = 'e.g., admin';
                }
            },

            populateLoginDropdown() {
                Store.init();
                const db = Store.get();
                const select = document.getElementById('officer-select');
                select.innerHTML = '<option value="">-- Select Your Territory --</option>';

                const officers = db.users.filter(u => u.role === 'officer').sort((a, b) => a.username.localeCompare(b.username));

                officers.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.username;
                    opt.text = `${u.username}`;
                    select.appendChild(opt);
                });
            },

            initApp() {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-layout').classList.remove('hidden');

                document.getElementById('user-name').innerText = Auth.currentUser.officerName || Auth.currentUser.username;
                document.getElementById('user-avatar').innerText = Auth.currentUser.username.charAt(0).toUpperCase();
                document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });

                if (Auth.currentUser.role === 'admin') {
                    document.getElementById('admin-nav').classList.remove('hidden');
                    Router.navigate('admin-dashboard');
                } else {
                    document.getElementById('officer-nav').classList.remove('hidden');
                    Router.navigate('officer-dashboard');
                }

                this.loadDarkMode();
            },

            toggleDarkMode() {
                const html = document.documentElement;
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            },

            loadDarkMode() {
                if (localStorage.getItem('theme') === 'dark') {
                    document.documentElement.classList.add('dark');
                }
            },

            // SIDEBAR LOGIC
            toggleSidebar() {
                const sb = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const isOpen = !sb.classList.contains('-translate-x-full');

                if (isOpen) {
                    this.closeSidebar();
                } else {
                    this.openSidebar();
                }
            },

            openSidebar() {
                const sb = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                sb.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            },

            closeSidebar() {
                const sb = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                sb.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },

            // --- ADMIN VIEWS ---
            renderAdminDashboard(tableMode = 'compact') {
                const metrics = Calc.getMetrics();
                const db = Store.get();

                // Calculate Today Achievement for Admin View
                const todayAch = metrics.todayProj > 0 ? ((metrics.todayColl / metrics.todayProj) * 100).toFixed(1) : (metrics.todayColl > 0 ? '100+' : '0.0');

                const allTerritoryData = db.territories.map(t => {
                    const m = Calc.getMetrics(t.id);
                    // Calculate Last Day Achievement for the new column
                    const ldAch = m.yestProjAmt > 0 ? ((m.yestCollAmt / m.yestProjAmt) * 100).toFixed(1) : '0.0';
                    return { ...t, ...m, lastDayAch: ldAch };
                });

                // Helper to calculate totals
                const calculateTotals = (data) => {
                    const sums = {
                        targetFiles: 0, mtdProjFiles: 0, uniquePaidCodes: 0, tillDateNonPayFiles: 0,
                        targetAmt: 0, mtdProjRegular: 0, mtdProjAdvance: 0, mtdProjTotal: 0, mtdColl: 0,
                        yestProjAmt: 0, yestProjFiles: 0, yestCollAmt: 0, yestCollFiles: 0,
                        lmNpTargetAmt: 0, lmNpTargetFiles: 0, mtdLmNpColl: 0, mtdLmNpFiles: 0,
                        todayProj: 0, todayColl: 0
                    };

                    data.forEach(t => {
                        sums.targetFiles += parseInt(t.targetFiles) || 0;
                        sums.mtdProjFiles += parseInt(t.mtdProjFiles) || 0;
                        sums.uniquePaidCodes += parseInt(t.uniquePaidCodes) || 0;
                        sums.tillDateNonPayFiles += parseInt(t.tillDateNonPayFiles) || 0;
                        sums.targetAmt += parseFloat(t.targetAmt) || 0;
                        sums.mtdProjRegular += parseFloat(t.mtdProjRegular) || 0;
                        sums.mtdProjAdvance += parseFloat(t.mtdProjAdvance) || 0;
                        sums.mtdProjTotal += parseFloat(t.mtdProjTotal) || 0;
                        sums.mtdColl += parseFloat(t.mtdColl) || 0;
                        sums.yestProjAmt += parseFloat(t.yestProjAmt) || 0;
                        sums.yestProjFiles += parseInt(t.yestProjFiles) || 0;
                        sums.yestCollAmt += parseFloat(t.yestCollAmt) || 0;
                        sums.yestCollFiles += parseInt(t.yestCollFiles) || 0;
                        sums.lmNpTargetAmt += parseFloat(t.lmNpTargetAmt) || 0;
                        sums.lmNpTargetFiles += parseInt(t.lmNpTargetFiles) || 0;
                        sums.mtdLmNpColl += parseFloat(t.mtdLmNpColl) || 0;
                        sums.mtdLmNpFiles += parseInt(t.mtdLmNpFiles) || 0;
                        sums.todayProj += parseFloat(t.todayProj) || 0;
                        sums.todayColl += parseFloat(t.todayColl) || 0;
                    });

                    // Derived Metrics for Totals
                    sums.tillDayAchievement = sums.mtdProjRegular > 0 ? ((sums.mtdColl / sums.mtdProjRegular) * 100).toFixed(1) : '0.0';
                    sums.achievement = sums.targetAmt > 0 ? ((sums.mtdColl / sums.targetAmt) * 100).toFixed(1) : '0.0';
                    sums.lastDayAch = sums.yestProjAmt > 0 ? ((sums.yestCollAmt / sums.yestProjAmt) * 100).toFixed(1) : '0.0';

                    const cureRate = sums.targetFiles > 0 ? (sums.uniquePaidCodes / sums.targetFiles) * 100 : 0;
                    const lmNpRecPct = sums.lmNpTargetAmt > 0 ? (sums.mtdLmNpColl / sums.lmNpTargetAmt) * 100 : 0;

                    let projAcc = 0;
                    if (sums.todayProj > 0) {
                        const diff = Math.abs(sums.todayProj - sums.todayColl);
                        projAcc = Math.max(0, (1 - (diff / sums.todayProj)) * 100);
                    } else if (sums.todayColl > 0) {
                        projAcc = 0;
                    } else {
                        projAcc = 100;
                    }

                    // Weighted RPI for Group
                    sums.rpi = ((parseFloat(sums.achievement) * 0.4) + (projAcc * 0.2) + (lmNpRecPct * 0.2) + (cureRate * 0.2)).toFixed(1);

                    return sums;
                };

                // Group Data
                const partAData = allTerritoryData.filter(t => t.part === 'A').sort((a, b) => parseFloat(b.rpi) - parseFloat(a.rpi));
                const partBData = allTerritoryData.filter(t => t.part === 'B').sort((a, b) => parseFloat(b.rpi) - parseFloat(a.rpi));

                const totalA = calculateTotals(partAData);
                const totalB = calculateTotals(partBData);
                const totalGrand = calculateTotals(allTerritoryData);

                // Row HTML Generator
                const createRow = (t, isTotal = false, label = '') => {
                    const isCompact = tableMode === 'compact';
                    return `
                    <tr class="${isTotal ? 'bg-slate-200 dark:bg-slate-700 font-bold border-y-2 border-slate-300 dark:border-slate-600' : 'hover:bg-slate-50 dark:hover:bg-slate-800/50 transition interactive-row border-b border-slate-100 dark:border-slate-700'} text-slate-700 dark:text-slate-300">
                        <td class="p-1.5 border dark:border-slate-600 ${isTotal ? '' : 'sticky left-0 bg-white dark:bg-dark-card'} text-center">${isTotal ? '' : t.part}</td>
                        <td class="p-1.5 border dark:border-slate-600 ${isTotal ? 'text-right' : 'sticky left-10 bg-white dark:bg-dark-card shadow-sm'} font-medium">
                            ${isTotal ? label : t.name}
                        </td>
                        <td class="p-1.5 border dark:border-slate-600 text-center">${t.targetFiles}</td>
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-center">${t.mtdProjFiles}</td>` : ''}
                        <td class="p-1.5 border dark:border-slate-600 text-center ${!isTotal ? 'font-semibold text-blue-600' : ''}">${t.uniquePaidCodes}</td>
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-center ${!isTotal ? 'text-red-500' : ''}">${t.tillDateNonPayFiles}</td>` : ''}
                        
                        <td class="p-1.5 border dark:border-slate-600 text-right font-medium">${parseInt(t.targetAmt).toLocaleString()}</td>
                        
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-right ${!isTotal ? 'text-slate-500' : ''}">${parseInt(t.mtdProjRegular).toLocaleString()}</td>` : ''}
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-right ${!isTotal ? 'text-slate-500' : ''}">${parseInt(t.mtdProjAdvance).toLocaleString()}</td>` : ''}
                        
                        <td class="p-1.5 border dark:border-slate-600 text-right font-bold ${!isTotal ? 'text-brand-600' : ''}">${parseInt(t.mtdProjTotal).toLocaleString()}</td>
                        <td class="p-1.5 border dark:border-slate-600 text-right font-bold ${!isTotal ? 'text-green-600' : ''}">${parseInt(t.mtdColl).toLocaleString()}</td>
                        <td class="p-1.5 border dark:border-slate-600 text-center font-bold bg-blue-50 dark:bg-blue-900/20">${t.achievement}%</td>
                        
                        <td class="p-1.5 border dark:border-slate-600 text-right ${!isTotal ? 'text-slate-500' : ''} border-l-2 border-slate-100 dark:border-slate-600">${parseInt(t.yestProjAmt).toLocaleString()}</td>
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-center ${!isTotal ? 'text-slate-500' : ''}">${t.yestProjFiles}</td>` : ''}
                        <td class="p-1.5 border dark:border-slate-600 text-right ${!isTotal ? 'text-slate-500' : ''}">${parseInt(t.yestCollAmt).toLocaleString()}</td>
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-center ${!isTotal ? 'text-slate-500' : ''}">${t.yestCollFiles}</td>` : ''}
                        <td class="p-1.5 border dark:border-slate-600 text-center font-bold text-orange-500">${t.lastDayAch}%</td>
                        
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-right ${!isTotal ? 'text-rose-800 bg-rose-50 dark:bg-rose-900/20' : ''} border-l-2 border-slate-100 dark:border-slate-600">${parseInt(t.lmNpTargetAmt).toLocaleString()}</td>` : ''}
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-center ${!isTotal ? 'text-rose-800 bg-rose-50 dark:bg-rose-900/20' : ''}">${t.lmNpTargetFiles}</td>` : ''}
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-right font-bold ${!isTotal ? 'text-rose-600' : ''}">${parseInt(t.mtdLmNpColl).toLocaleString()}</td>` : ''}
                        ${!isCompact ? `<td class="p-1.5 border dark:border-slate-600 text-center font-bold ${!isTotal ? 'text-rose-600' : ''}">${t.mtdLmNpFiles}</td>` : ''}
                    </tr>`;
                };

                const topPerformers = [...allTerritoryData].sort((a, b) => parseFloat(b.rpi) - parseFloat(a.rpi)).slice(0, 5);
                const bottomPerformers = [...allTerritoryData].sort((a, b) => parseFloat(a.rpi) - parseFloat(b.rpi)).slice(0, 5);

                const today = new Date();
                const trendLabels = [];
                const trendData = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    trendLabels.push(dateStr.slice(5));
                    const dailySum = db.collections.filter(c => c.date === dateStr).reduce((acc, curr) => acc + parseFloat(curr.amount), 0);
                    trendData.push(dailySum);
                }

                const modes = ['Bank Transfer', 'bKash', 'Cheque', 'Cash'];
                const modeData = modes.map(m => db.collections.filter(c => c.date.startsWith(today.toISOString().slice(0, 7)) && c.mode === m).reduce((s, c) => s + parseFloat(c.amount), 0));

                const container = document.getElementById('views-container');
                const isCompact = tableMode === 'compact';

                container.innerHTML = `
                    <div class="animate-entry space-y-4"> 
                        
                        <!-- DASHBOARD HEADER -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-2">
                            <div>
                                <h2 class="text-2xl font-black text-slate-800 dark:text-white">Admin Intelligence Dashboard</h2>
                                <p class="text-xs text-slate-500 font-medium">Monthly Recovery Performance Metrics & Strategic Analytics</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="UI.captureDashboard()" class="flex items-center px-4 py-2 bg-white dark:bg-slate-800 border-2 border-brand-500 text-brand-600 dark:text-brand-400 rounded-xl hover:bg-brand-50 dark:hover:bg-brand-900/30 transition-all font-bold text-sm shadow-lg shadow-brand-500/10 hover-lift">
                                    <i class="fa-solid fa-camera-retro mr-2"></i> Capture Report for Email
                                </button>
                            </div>
                        </div>
                        
                        <!-- GLOBAL RPI BANNER -->
                        <div class="p-4 rounded-2xl border ${Calc.getRPIBg(metrics.rpi)} flex items-center justify-between shadow-sm hover-lift">
                            <div>
                                <h3 class="text-base font-bold text-slate-800 dark:text-white leading-tight">Global Recovery Index (RPI)</h3>
                                <p class="text-[11px] opacity-80">Aggregate Performance across all territories</p>
                            </div>
                            <div class="text-3xl font-black ${Calc.getRPIColor(metrics.rpi)}">${metrics.rpi}</div>
                        </div>

                        <!-- COMPACT METRIC TABLE -->
                        <div class="mb-4 overflow-hidden rounded-xl shadow-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-dark-card">
                            <table class="w-full text-xs text-left border-collapse">
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    <!-- Row 1 -->
                                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700 w-1/4">
                                            <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Total Target</span>
                                                <span class="font-bold text-slate-800 dark:text-white">${parseInt(metrics.targetAmt).toLocaleString()}</span>
                                            </div>
                                        </td>
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700 w-1/4">
                                            <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Total Files</span>
                                                <span class="font-bold text-slate-800 dark:text-white">${metrics.targetFiles}</span>
                                            </div>
                                        </td>
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700 w-1/4">
                                             <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Today Proj</span>
                                                <span class="font-bold text-slate-800 dark:text-white">${parseInt(metrics.todayProj).toLocaleString()}</span>
                                            </div>
                                        </td>
                                        <td class="p-2 w-1/4">
                                             <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Remaining</span>
                                                <span class="font-bold text-amber-600">${parseInt(metrics.remainingAmt).toLocaleString()}</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Row 2 -->
                                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700">
                                            <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Till Date Coll</span>
                                                <span class="font-bold text-emerald-600">${parseInt(metrics.mtdColl).toLocaleString()}</span>
                                            </div>
                                        </td>
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700">
                                            <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Coll Files</span>
                                                <span class="font-bold text-emerald-600">${metrics.uniquePaidCodes}</span>
                                            </div>
                                        </td>
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700">
                                            <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Collection</span>
                                                <span class="font-bold text-emerald-600">${parseInt(metrics.todayColl).toLocaleString()}</span>
                                            </div>
                                        </td>
                                        <td class="p-2">
                                            <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Daily Req</span>
                                                <span class="font-bold text-red-600">${parseInt(Math.round(metrics.rdrr)).toLocaleString()}</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Row 3 -->
                                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700">
                                            <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Ach % (MTD)</span>
                                                <span class="font-bold text-indigo-600">${metrics.achievement}%</span>
                                            </div>
                                        </td>
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700">
                                             <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Uncollected</span>
                                                <span class="font-bold text-rose-600">${metrics.tillDateNonPayFiles}</span>
                                            </div>
                                        </td>
                                        <td class="p-2 border-r border-slate-100 dark:border-slate-700">
                                             <div class="flex justify-between items-center">
                                                <span class="text-slate-500 font-bold uppercase tracking-tight">Ach % (Today)</span>
                                                <span class="font-bold text-fuchsia-600">${todayAch}%</span>
                                            </div>
                                        </td>
                                        <td class="p-2 flex justify-center opacity-30">
                                            <i class="fa-solid fa-globe text-slate-400"></i>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                         
                        <!-- PART-WISE EXECUTIVE SUMMARY (NEW) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                            <!-- Part A Card -->
                            <div class="relative overflow-hidden rounded-2xl bg-white dark:bg-dark-card border border-emerald-100 dark:border-emerald-900/30 shadow-lg group hover-lift">
                                 <div class="absolute -right-4 -top-4 opacity-5 transform rotate-12 transition-transform group-hover:scale-110 group-hover:opacity-10">
                                    <span class="text-8xl font-black text-emerald-900">A</span>
                                 </div>
                                 <div class="p-4 relative z-10">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 flex items-center justify-center font-black text-lg shadow-sm border border-emerald-100 dark:border-emerald-800">A</div>
                                            <div>
                                                <h3 class="text-base font-bold text-slate-800 dark:text-white leading-tight">Part A Recovery</h3>
                                                <p class="text-[10px] text-slate-500 font-medium">North & Central Portfolio</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">RPI Score</p>
                                            <p class="text-xl font-black text-emerald-600">${totalA.rpi}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-x-3 gap-y-2 mb-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700/50">
                                        <div>
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Target Amt</p>
                                            <p class="text-base font-bold text-slate-700 dark:text-slate-300">${parseInt(totalA.targetAmt).toLocaleString()}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Coll Amt</p>
                                            <p class="text-base font-bold text-emerald-600">${parseInt(totalA.mtdColl).toLocaleString()}</p>
                                        </div>
                                        <div class="border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Today Proj</p>
                                            <p class="text-base font-bold text-slate-700 dark:text-slate-300">${parseInt(totalA.todayProj).toLocaleString()}</p>
                                        </div>
                                        <div class="text-right border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Today Coll</p>
                                            <p class="text-base font-bold text-emerald-600">${parseInt(totalA.todayColl).toLocaleString()}</p>
                                        </div>
                                        <div class="border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Last Day Proj</p>
                                            <p class="text-base font-bold text-slate-700 dark:text-slate-300">${parseInt(totalA.yestProjAmt).toLocaleString()}</p>
                                        </div>
                                        <div class="text-right border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Last Day Coll</p>
                                            <p class="text-base font-bold text-emerald-600">${parseInt(totalA.yestCollAmt).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between text-[11px] font-bold">
                                            <span class="text-slate-600 dark:text-slate-400">Achievement</span>
                                            <span class="text-emerald-600">${totalA.achievement}%</span>
                                        </div>
                                        <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden shadow-inner">
                                            <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-full rounded-full transition-all duration-1000 shadow-lg" style="width: ${Math.min(totalA.achievement, 100)}%"></div>
                                        </div>
                                    </div>
                                 </div>
                            </div>

                            <!-- Part B Card -->
                            <div class="relative overflow-hidden rounded-2xl bg-white dark:bg-dark-card border border-blue-100 dark:border-blue-900/30 shadow-lg group hover-lift">
                                 <div class="absolute -right-4 -top-4 opacity-5 transform rotate-12 transition-transform group-hover:scale-110 group-hover:opacity-10">
                                    <span class="text-8xl font-black text-blue-900">B</span>
                                 </div>
                                 <div class="p-4 relative z-10">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 flex items-center justify-center font-black text-lg shadow-sm border border-blue-100 dark:border-blue-800">B</div>
                                            <div>
                                                <h3 class="text-base font-bold text-slate-800 dark:text-white leading-tight">Part B Recovery</h3>
                                                <p class="text-[10px] text-slate-500 font-medium">South & East Portfolio</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">RPI Score</p>
                                            <p class="text-xl font-black text-blue-600">${totalB.rpi}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-x-3 gap-y-2 mb-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700/50">
                                        <div>
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Target Amt</p>
                                            <p class="text-base font-bold text-slate-700 dark:text-slate-300">${parseInt(totalB.targetAmt).toLocaleString()}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Coll Amt</p>
                                            <p class="text-base font-bold text-blue-600">${parseInt(totalB.mtdColl).toLocaleString()}</p>
                                        </div>
                                        <div class="border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Today Proj</p>
                                            <p class="text-base font-bold text-slate-700 dark:text-slate-300">${parseInt(totalB.todayProj).toLocaleString()}</p>
                                        </div>
                                        <div class="text-right border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Today Coll</p>
                                            <p class="text-base font-bold text-blue-600">${parseInt(totalB.todayColl).toLocaleString()}</p>
                                        </div>
                                        <div class="border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Last Day Proj</p>
                                            <p class="text-base font-bold text-slate-700 dark:text-slate-300">${parseInt(totalB.yestProjAmt).toLocaleString()}</p>
                                        </div>
                                        <div class="text-right border-t border-slate-200 dark:border-slate-700 pt-1">
                                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Last Day Coll</p>
                                            <p class="text-base font-bold text-blue-600">${parseInt(totalB.yestCollAmt).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between text-[11px] font-bold">
                                            <span class="text-slate-600 dark:text-slate-400">Achievement</span>
                                            <span class="text-blue-600">${totalB.achievement}%</span>
                                        </div>
                                        <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden shadow-inner">
                                            <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-full rounded-full transition-all duration-1000 shadow-lg" style="width: ${Math.min(totalB.achievement, 100)}%"></div>
                                        </div>
                                    </div>
                                 </div>
                            </div>
                        </div>

                        <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card border-t-4 border-brand-500">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800 dark:text-white">Territory Performance Ranking</h3>
                                    <div class="text-xs text-slate-500 italic">Live tracking of MTD and Daily performance</div>
                                </div>
                                <div class="flex items-center space-x-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                    <button onclick="UI.renderAdminDashboard('compact')" class="px-3 py-1.5 text-xs font-bold rounded-md transition-all ${isCompact ? 'bg-white dark:bg-slate-600 text-brand-600 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                        <i class="fa-solid fa-compress mr-1"></i> Focused
                                    </button>
                                    <button onclick="UI.renderAdminDashboard('full')" class="px-3 py-1.5 text-xs font-bold rounded-md transition-all ${!isCompact ? 'bg-white dark:bg-slate-600 text-brand-600 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                        <i class="fa-solid fa-expand mr-1"></i> Detailed
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto pb-4">
                                <table class="w-full text-xs text-left border-collapse whitespace-nowrap">
                                    <thead class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 uppercase tracking-wider font-bold">
                                        <tr>
                                            <th class="p-2 border dark:border-slate-600 sticky left-0 bg-slate-100 dark:bg-slate-700 z-10 shadow-sm text-center">Part</th>
                                            <th class="p-2 border dark:border-slate-600 sticky left-10 bg-slate-100 dark:bg-slate-700 z-10 shadow-sm">Territory</th>
                                            <th class="p-2 border dark:border-slate-600 bg-blue-50 dark:bg-slate-800/50">Total Files</th>
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-blue-50 dark:bg-slate-800/50">Proj Files (MTD)</th>` : ''}
                                            <th class="p-2 border dark:border-slate-600 bg-blue-50 dark:bg-slate-800/50">Paid Files</th>
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-blue-50 dark:bg-slate-800/50">Non-Pay Files</th>` : ''}
                                            
                                            <th class="p-2 border dark:border-slate-600">Total EMI</th>
                                            
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600">Proj (Reg)</th>` : ''}
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600">Proj (Adv)</th>` : ''}
                                            
                                            <th class="p-2 border dark:border-slate-600 font-bold">Total Proj</th>
                                            <th class="p-2 border dark:border-slate-600 bg-green-50 dark:bg-green-900/10">Till Day Coll</th>
                                            <th class="p-2 border dark:border-slate-600 bg-blue-50 dark:bg-blue-900/20">Ach %</th>
                                            
                                            <th class="p-2 border dark:border-slate-600 bg-orange-50 dark:bg-orange-900/10 border-l-2 border-slate-200 dark:border-slate-600">Last Day Proj Amt</th>
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-orange-50 dark:bg-orange-900/10">Last Day Proj Files</th>` : ''}
                                            <th class="p-2 border dark:border-slate-600 bg-orange-50 dark:bg-orange-900/10">Last Day Coll Amt</th>
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-orange-50 dark:bg-orange-900/10">Last Day Coll Files</th>` : ''}
                                            <th class="p-2 border dark:border-slate-600 bg-orange-100 dark:bg-orange-900/30 font-bold text-orange-700">Last Day Ach%</th>
 
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-rose-50 dark:bg-rose-900/10 border-l-2 border-slate-200 dark:border-slate-600">LM NP Amount</th>` : ''}
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-rose-50 dark:bg-rose-900/10">LM NP Files</th>` : ''}
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-rose-50 dark:bg-rose-900/10">LM NP Rec (Amt)</th>` : ''}
                                            ${!isCompact ? `<th class="p-2 border dark:border-slate-600 bg-rose-50 dark:bg-rose-900/10">LM NP Rec (Files)</th>` : ''}
                                        </tr>
                                    </thead>
                                    <tbody id="ranking-table-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card hover-lift">
                                <h3 class="text-lg font-bold mb-4">Part A vs Part B</h3>
                                <div class="h-48 flex justify-center">
                                    <canvas id="chart-part-comparison"></canvas>
                                </div>
                            </div>
                            
                            <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card hover-lift flex flex-col justify-center">
                                <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white flex items-center">
                                    <i class="fa-solid fa-file-export mr-2 text-brand-500"></i> Reports & Exports
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700 transition hover:border-brand-200 dark:hover:border-brand-800">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-4 shadow-sm">
                                                <i class="fa-solid fa-chart-simple"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-slate-700 dark:text-slate-200 text-sm">Performance Summary</p>
                                                <p class="text-xs text-slate-500">Current Month Territory Ranking</p>
                                            </div>
                                        </div>
                                        <button onclick="UI.exportCSV()" class="px-4 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-bold text-slate-600 dark:text-slate-300 hover:text-brand-600 hover:border-brand-500 transition-all shadow-sm">
                                            Download
                                        </button>
                                    </div>

                                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700 transition hover:border-brand-200 dark:hover:border-brand-800">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center mr-4 shadow-sm">
                                                <i class="fa-solid fa-database"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-slate-700 dark:text-slate-200 text-sm">Raw Collection Data</p>
                                                <p class="text-xs text-slate-500">Customer-wise Detailed Report</p>
                                            </div>
                                        </div>
                                        <button onclick="UI.openRawExportModal()" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-xs font-bold transition-all shadow-md shadow-brand-500/20">
                                            Select Period
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                            <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card border-l-4 border-green-500 hover-lift">
                                <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white flex items-center">
                                    <i class="fa-solid fa-trophy text-yellow-500 mr-2"></i> Top Performing Territories
                                </h3>
                                <div class="overflow-hidden rounded-lg border border-slate-100 dark:border-slate-700">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-green-50 dark:bg-green-900/20 text-xs font-bold text-green-800 dark:text-green-300">
                                            <tr>
                                                <th class="px-4 py-2">Territory</th>
                                                <th class="px-4 py-2">Officer</th>
                                                <th class="px-4 py-2 text-right">Ach %</th>
                                                <th class="px-4 py-2 text-right">RPI</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                            ${topPerformers.map(t => `
                                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                    <td class="px-4 py-2 font-medium">${t.name}</td>
                                                    <td class="px-4 py-2 text-xs text-slate-500">${t.officer}</td>
                                                    <td class="px-4 py-2 text-right font-bold text-slate-700 dark:text-slate-300">${t.achievement}%</td>
                                                    <td class="px-4 py-2 text-right font-bold text-green-600">${t.rpi}</td>
                                                </tr>
                                            `).join('')}
                                            ${topPerformers.length === 0 ? '<tr><td colspan="4" class="px-4 py-4 text-center text-slate-400">No data available</td></tr>' : ''}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card border-l-4 border-red-500 hover-lift">
                                <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white flex items-center">
                                    <i class="fa-solid fa-triangle-exclamation text-red-500 mr-2"></i> Critical Attention Needed
                                </h3>
                                <div class="overflow-hidden rounded-lg border border-slate-100 dark:border-slate-700">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-red-50 dark:bg-red-900/20 text-xs font-bold text-red-800 dark:text-red-300">
                                            <tr>
                                                <th class="px-4 py-2">Territory</th>
                                                <th class="px-4 py-2">Officer</th>
                                                <th class="px-4 py-2 text-right">Ach %</th>
                                                <th class="px-4 py-2 text-right">RPI</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                            ${bottomPerformers.map(t => `
                                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                    <td class="px-4 py-2 font-medium">${t.name}</td>
                                                    <td class="px-4 py-2 text-xs text-slate-500">${t.officer}</td>
                                                    <td class="px-4 py-2 text-right font-bold text-slate-700 dark:text-slate-300">${t.achievement}%</td>
                                                    <td class="px-4 py-2 text-right font-bold text-red-500">${t.rpi}</td>
                                                </tr>
                                            `).join('')}
                                            ${bottomPerformers.length === 0 ? '<tr><td colspan="4" class="px-4 py-4 text-center text-slate-400">No data available</td></tr>' : ''}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white flex items-center">
                                <i class="fa-solid fa-brain text-brand-500 mr-2"></i> Strategic Analytics
                            </h3>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card lg:col-span-2 hover-lift">
                                    <h4 class="font-bold mb-4 text-sm text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                                        <i class="fa-solid fa-arrow-trend-up mr-2 text-brand-500"></i> Global Collection Momentum (Last 7 Days)
                                    </h4>
                                    <div class="relative h-64">
                                        <canvas id="admin-global-trend"></canvas>
                                    </div>
                                </div>

                                <div class="space-y-6">
                                    <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card hover-lift">
                                        <h4 class="font-bold mb-4 text-sm text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                                            <i class="fa-solid fa-wallet mr-2 text-blue-500"></i> Channel Mix (MTD)
                                        </h4>
                                        <div class="relative h-48">
                                            <canvas id="admin-mode-chart"></canvas>
                                        </div>
                                    </div>

                                    <div class="glass-panel p-6 rounded-xl shadow-lg dark:bg-dark-card hover-lift border-l-4 border-rose-500">
                                        <h4 class="font-bold mb-2 text-sm text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                                            LMNP Efficiency
                                        </h4>
                                        <div class="flex justify-between items-end mb-2">
                                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${metrics.lmNpRecPct}%</span>
                                            <span class="text-xs text-rose-500 font-medium">Rec. of Last Month NP</span>
                                        </div>
                                        <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2 mb-2">
                                            <div class="bg-rose-500 h-2 rounded-full transition-all duration-1000" style="width: ${metrics.lmNpRecPct}%"></div>
                                        </div>
                                        <p class="text-xs text-slate-400">Target: <span class="font-medium text-slate-600 dark:text-slate-300">${parseInt(metrics.lmNpTargetAmt).toLocaleString()}</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 `;

                const tbody = document.getElementById('ranking-table-body');

                // Render Part A
                partAData.forEach((t, i) => tbody.innerHTML += createRow(t));
                // Total Part A
                tbody.innerHTML += createRow(totalA, true, 'Total Part A');

                // Render Part B
                partBData.forEach((t, i) => tbody.innerHTML += createRow(t));
                // Total Part B
                tbody.innerHTML += createRow(totalB, true, 'Total Part B');

                // Grand Total
                tbody.innerHTML += createRow(totalGrand, true, 'Grand Total');

                const partA = totalA.mtdColl;
                const partB = totalB.mtdColl;
                setTimeout(() => {
                    Charts.renderDoughnut('chart-part-comparison', ['Part A', 'Part B'], [partA, partB]);
                    Charts.renderLine('admin-global-trend', trendLabels, trendData);
                    Charts.renderDoughnut('admin-mode-chart', modes, modeData);
                }, 100);
            },

            renderAdminOffroadView(viewMode = 'active') {
                const db = Store.get();
                // Get filter values (handle potential nulls/undefined)
                const fTerritory = document.getElementById('offroad-filter-territory')?.value || '';
                const fMonth = document.getElementById('offroad-filter-month')?.value || '';
                const fReason = document.getElementById('offroad-filter-reason')?.value || '';

                // Flatten data with territory names and apply filters
                const allCases = db.offroad_vehicles.map(v => {
                    const t = db.territories.find(ter => ter.id === v.territoryId);
                    return { ...v, territoryName: t ? t.name : 'Unknown' };
                }).filter(v => {
                    const matchesStatus = v.status === (viewMode === 'active' ? 'Active' : 'Solved');
                    const matchesTerritory = !fTerritory || v.territoryId === fTerritory;
                    const matchesMonth = !fMonth || v.inDate.startsWith(fMonth);
                    const matchesReason = !fReason || v.reason === fReason;
                    return matchesStatus && matchesTerritory && matchesMonth && matchesReason;
                }).sort((a, b) => new Date(b.inDate) - new Date(a.inDate));

                // Global Stats for toggle counts
                const activeCount = db.offroad_vehicles.filter(v => v.status === 'Active').length;
                const resolvedCount = db.offroad_vehicles.filter(v => v.status === 'Solved').length;

                // Dashboard Stats (based on filtered list)
                const totalFiltered = allCases.length;
                const captured = allCases.filter(v => v.reason === 'Capture').length;
                const accident = allCases.filter(v => v.reason === 'Accident').length;
                const thana = allCases.filter(v => v.reason === 'Thana/Police station').length;
                const others = allCases.filter(v => v.reason === 'Lost or untraceable').length;

                const allIds = allCases.map(d => d.id);

                document.getElementById('views-container').innerHTML = `
                    <div class="animate-entry">
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Offroad Tracker</h2>
                                <p class="text-sm text-slate-500">Comprehensive audit of vehicle incidents & recoveries</p>
                            </div>
                            
                            <div class="flex flex-wrap items-center gap-3">
                                <button onclick="UI.openOffroadModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-lg hover:bg-red-700 transition flex items-center font-bold text-sm">
                                    <i class="fa-solid fa-plus mr-2"></i> New Report
                                </button>
                                
                                <div class="bg-slate-200 dark:bg-slate-700 p-1 rounded-lg inline-flex">
                                    <button onclick="UI.renderAdminOffroadView('active')" class="px-4 py-2 rounded-md text-sm font-bold transition-all ${viewMode === 'active' ? 'bg-white dark:bg-slate-600 text-brand-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}">
                                        Active (${activeCount})
                                    </button>
                                    <button onclick="UI.renderAdminOffroadView('archive')" class="px-4 py-2 rounded-md text-sm font-bold transition-all ${viewMode === 'archive' ? 'bg-white dark:bg-slate-600 text-brand-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}">
                                        Archive (${resolvedCount})
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Offroad Dashboard -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                            <div class="glass-panel p-5 rounded-2xl border-b-4 border-slate-500 shadow-sm hover-lift bg-slate-100/50 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 opacity-5 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-clipboard-list text-6xl"></i>
                                </div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Result</p>
                                <p class="text-3xl font-black text-slate-800 dark:text-white">${totalFiltered}</p>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl border-l-4 border-orange-500 shadow-sm hover-lift bg-orange-50/20 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 opacity-5 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform text-orange-600">
                                    <i class="fa-solid fa-truck-pickup text-6xl"></i>
                                </div>
                                <p class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-1">Captured</p>
                                <p class="text-3xl font-black text-slate-800 dark:text-white">${captured}</p>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl border-l-4 border-blue-500 shadow-sm hover-lift bg-blue-50/20 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 opacity-5 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform text-blue-600">
                                    <i class="fa-solid fa-car-burst text-6xl"></i>
                                </div>
                                <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">Accident</p>
                                <p class="text-3xl font-black text-slate-800 dark:text-white">${accident}</p>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl border-l-4 border-indigo-500 shadow-sm hover-lift bg-indigo-50/20 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 opacity-5 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform text-indigo-600">
                                    <i class="fa-solid fa-building-shield text-6xl"></i>
                                </div>
                                <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Thana</p>
                                <p class="text-3xl font-black text-slate-800 dark:text-white">${thana}</p>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl border-l-4 border-rose-500 shadow-sm hover-lift bg-rose-50/20 relative overflow-hidden group">
                                <div class="absolute right-0 top-0 opacity-5 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform text-rose-600">
                                    <i class="fa-solid fa-magnifying-glass-location text-6xl"></i>
                                </div>
                                <p class="text-[10px] font-black text-rose-500 uppercase tracking-widest mb-1">Others</p>
                                <p class="text-3xl font-black text-slate-800 dark:text-white">${others}</p>
                            </div>
                        </div>

                        <!-- Filter Bar -->
                        <div class="glass-panel p-4 rounded-xl border border-slate-200 dark:border-slate-700 mb-6 flex flex-wrap gap-4 items-end bg-slate-50/50">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Territory</label>
                                <select id="offroad-filter-territory" onchange="UI.renderAdminOffroadView('${viewMode}')" class="w-full p-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:border-brand-500 shadow-sm">
                                    <option value="">All Territories</option>
                                    ${db.territories.map(t => `<option value="${t.id}" ${fTerritory === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Month</label>
                                <input type="month" id="offroad-filter-month" value="${fMonth}" onchange="UI.renderAdminOffroadView('${viewMode}')" class="w-full p-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:border-brand-500 shadow-sm">
                            </div>
                            <div class="flex-1 min-w-[180px]">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Reason</label>
                                <select id="offroad-filter-reason" onchange="UI.renderAdminOffroadView('${viewMode}')" class="w-full p-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:border-brand-500 shadow-sm">
                                    <option value="">All Reasons</option>
                                    <option value="Accident" ${fReason === 'Accident' ? 'selected' : ''}>Accident</option>
                                    <option value="Capture" ${fReason === 'Capture' ? 'selected' : ''}>Capture</option>
                                    <option value="Thana/Police station" ${fReason === 'Thana/Police station' ? 'selected' : ''}>Thana/Police station</option>
                                    <option value="Lost or untraceable" ${fReason === 'Lost or untraceable' ? 'selected' : ''}>Lost or untraceable</option>
                                </select>
                            </div>
                            <button onclick="UI.exportOffroadCSV('${viewMode}')" class="px-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 hover:text-brand-600 transition-all flex items-center shadow-sm">
                                <i class="fa-solid fa-file-csv mr-2 text-emerald-500"></i> <span class="text-xs font-bold uppercase">Export</span>
                            </button>
                        </div>

                        <!-- Data List (Table View) -->
                        <div class="glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden border border-slate-200 dark:border-slate-700">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 dark:bg-slate-800 text-[10px] text-slate-500 uppercase font-black tracking-widest border-b dark:border-slate-700">
                                        <tr>
                                            <th class="px-6 py-4">In Date</th>
                                            ${viewMode === 'archive' ? '<th class="px-6 py-4">Release</th>' : ''}
                                            <th class="px-6 py-4">Customer Code</th>
                                            <th class="px-6 py-4 w-40">Reason</th>
                                            <th class="px-6 py-4">Territory</th>
                                            <th class="px-6 py-4">Location</th>
                                            <th class="px-6 py-4">Remarks</th>
                                            <th class="px-6 py-4 text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${allCases.map(v => `
                                            <tr class="hover:bg-slate-50/80 dark:hover:bg-slate-800/80 transition cursor-pointer group" onclick="if(!event.target.closest('button')) UI.openOffroadModal('${v.id}')">
                                                <td class="px-6 py-4 font-mono text-xs text-slate-500">${v.inDate}</td>
                                                ${viewMode === 'archive' ? `<td class="px-6 py-4 font-mono text-xs text-green-600 font-bold">${v.solveDate || '-'}</td>` : ''}
                                                <td class="px-6 py-4">
                                                    <span class="font-black text-slate-800 dark:text-white font-mono group-hover:text-brand-600 transition-colors uppercase">${v.customerCode}</span>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase shrink-0 ${UI.getOffroadBadgeColor(v.reason)}">
                                                        <i class="fa-solid ${UI.getOffroadIcon(v.reason)} mr-1"></i> ${v.reason}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-xs font-semibold text-slate-600 dark:text-slate-400">${v.territoryName}</td>
                                                <td class="px-6 py-4 text-xs max-w-xs truncate">${v.location || 'N/A'}</td>
                                                <td class="px-6 py-4 text-xs italic text-slate-400 max-w-xs truncate">"${v.remarks || ''}"</td>
                                                <td class="px-6 py-4 text-center">
                                                    <div class="flex items-center justify-center gap-2">
                                                        ${viewMode === 'active' ? `
                                                            <button onclick="event.stopPropagation(); UI.resolveOffroad('${v.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-green-50 text-green-600 hover:bg-green-600 hover:text-white transition-all border border-green-200" title="Release">
                                                                <i class="fa-solid fa-check"></i>
                                                            </button>` : ''}
                                                        <button onclick="event.stopPropagation(); UI.openOffroadModal('${v.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all border border-blue-200" title="Edit">
                                                            <i class="fa-solid fa-pen"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                        ${allCases.length === 0 ? `<tr><td colspan="${viewMode === 'active' ? 7 : 8}" class="px-6 py-12 text-center text-slate-400 italic">No matching ${viewMode} records found.</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            // --- ADMIN PROJECTION MONITOR (NEW) ---
            renderAdminProjections() {
                const db = Store.get();
                const today = new Date().toISOString().split('T')[0];

                // Group territories
                const submitted = [];
                const missing = [];

                db.territories.forEach(t => {
                    const proj = db.projections.find(p => p.territoryId === t.id && p.date === today);
                    if (proj) {
                        submitted.push({ ...t, proj });
                    } else {
                        missing.push(t);
                    }
                });

                document.getElementById('views-container').innerHTML = `
                    <div class="animate-entry max-w-6xl mx-auto">
                         <div class="mb-8">
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center">
                                <i class="fa-solid fa-stopwatch text-brand-500 mr-3"></i> Projection Monitor
                            </h2>
                            <p class="text-sm text-slate-500">Monitor and manage daily target submissions. <span class="font-bold text-slate-700 dark:text-slate-300">Date: ${today}</span></p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- MISSING COLUMN -->
                            <div class="space-y-4">
                                <div class="flex justify-between items-center px-2">
                                    <h3 class="font-bold text-red-500 uppercase tracking-wider text-sm">Missing Submissions (${missing.length})</h3>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full animate-pulse">Action Required</span>
                                </div>
                                
                                <div class="bg-white dark:bg-dark-card rounded-xl shadow-lg border border-red-100 dark:border-red-900/30 overflow-hidden">
                                    ${missing.length === 0 ?
                        `<div class="p-8 text-center text-slate-400 italic">All territories have submitted! 🎉</div>` :
                        `<div class="divide-y divide-slate-100 dark:divide-slate-700">
                                            ${missing.map(t => {
                            const isUnlocked = db.unlocks && db.unlocks[t.id] && db.unlocks[t.id] > Date.now();
                            return `
                                                <div class="p-4 flex items-center justify-between group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                    <div>
                                                        <p class="font-bold text-slate-700 dark:text-slate-200">${t.name}</p>
                                                        <p class="text-xs text-slate-500">${t.officer}</p>
                                                    </div>
                                                    ${isUnlocked ?
                                    `<span class="text-xs font-bold text-green-600 bg-green-100 px-3 py-1.5 rounded-lg flex items-center">
                                                            <i class="fa-solid fa-lock-open mr-2"></i> Unlocked
                                                        </span>` :
                                    `<button onclick="UI.unlockProjection('${t.id}')" class="text-xs font-bold text-white bg-slate-800 hover:bg-slate-900 px-3 py-1.5 rounded-lg shadow transition transform active:scale-95">
                                                            <i class="fa-solid fa-key mr-1"></i> Unlock 30m
                                                        </button>`
                                }
                                                </div>
                                            `;
                        }).join('')}
                                        </div>`
                    }
                                </div>
                            </div>

                            <!-- SUBMITTED COLUMN -->
                            <div class="space-y-4">
                                <div class="flex justify-between items-center px-2">
                                    <h3 class="font-bold text-emerald-500 uppercase tracking-wider text-sm">Submitted (${submitted.length})</h3>
                                    <span class="text-xs bg-emerald-100 text-emerald-600 px-2 py-1 rounded-full">Completed</span>
                                </div>

                                <div class="bg-white dark:bg-dark-card rounded-xl shadow-lg border border-emerald-100 dark:border-emerald-900/30 overflow-hidden">
                                     ${submitted.length === 0 ?
                        `<div class="p-8 text-center text-slate-400 italic">No projections submitted yet.</div>` :
                        `<div class="divide-y divide-slate-100 dark:divide-slate-700">
                                            ${submitted.map(item => `
                                                <div class="p-4 flex items-center justify-between group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                    <div>
                                                        <p class="font-bold text-slate-700 dark:text-slate-200">${item.name}</p>
                                                        <div class="flex items-center text-xs text-slate-500 mt-1 space-x-3">
                                                            <span><i class="fa-solid fa-money-bill-1-wave text-emerald-500 mr-1"></i> Reg: ${item.proj.regularAmount.toLocaleString()}</span>
                                                            <span><i class="fa-solid fa-hand-holding-dollar text-blue-500 mr-1"></i> Adv: ${item.proj.advanceAmount.toLocaleString()}</span>
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        <span class="text-[10px] text-slate-400 block mb-1">Files: ${item.proj.fileCount}</span>
                                                        <button onclick="UI.modalEditProjection('${item.proj.territoryId}', '${item.proj.regularAmount}', '${item.proj.advanceAmount}', '${item.proj.fileCount}')" class="text-xs text-blue-500 hover:text-blue-700 font-medium flex items-center justify-end">
                                                            <i class="fa-solid fa-pen-to-square mr-1"></i> Edit
                                                        </button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>`
                    }
                                </div>
                            </div>
                        </div>
                    </div>
            `;
            },

            unlockProjection(tId) {
                const db = Store.get();
                if (!db.unlocks) db.unlocks = {};

                // Unlock for 30 minutes
                db.unlocks[tId] = Date.now() + (30 * 60 * 1000);
                Store.save(db);

                // Visual feedback
                this.renderAdminProjections();
                // Optional: Toast notification could be added here
            },

            modalEditProjection(tId, reg, adv, files) {
                const html = `
            <h3 class="text-xl font-bold mb-4 text-slate-800 dark:text-white" > Edit Projection</h3 >
                    <p class="text-xs text-slate-500 mb-4">Modifying projection for selected territory.</p>
                    <form onsubmit="UI.handleAdminEditProjection(event, '${tId}')" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Regular</label>
                                <input type="number" name="reg" value="${reg}" class="w-full p-2.5 rounded-lg border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Advance</label>
                                <input type="number" name="adv" value="${adv}" class="w-full p-2.5 rounded-lg border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">File Count</label>
                            <input type="number" name="files" value="${files}" class="w-full p-2.5 rounded-lg border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="flex justify-end space-x-2 pt-2">
                            <button type="button" onclick="document.getElementById('generic-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md">Update</button>
                        </div>
                    </form>
        `;
                this.showModal(html);
            },

            handleAdminEditProjection(e, tId) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const db = Store.get();
                const today = new Date().toISOString().split('T')[0];

                const projIndex = db.projections.findIndex(p => p.territoryId === tId && p.date === today);

                const regAmt = formData.get('reg');
                const advAmt = formData.get('adv');

                const updatedProj = {
                    territoryId: tId,
                    date: today,
                    regularAmount: regAmt,
                    advanceAmount: advAmt || 0,
                    amount: parseFloat(regAmt) + parseFloat(advAmt || 0),
                    fileCount: formData.get('files')
                };

                if (projIndex !== -1) {
                    db.projections[projIndex] = updatedProj;
                } else {
                    db.projections.push(updatedProj);
                }

                Store.save(db);
                document.getElementById('generic-modal').classList.add('hidden');
                this.renderAdminProjections();
            },

            renderAdminSettlementsView() {
                const db = Store.get();
                // Join with territory names
                const settlements = db.settlements.map(s => {
                    const t = db.territories.find(ter => ter.id === s.territoryId);
                    return { ...s, territoryName: t ? t.name : 'Unknown' };
                }).sort((a, b) => new Date(b.date) - new Date(a.date));

                const countType = (type) => settlements.filter(s => s.type === type).length;

                const allIds = settlements.map(s => s.id);

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry" >
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Settlement & Closure Vault</h2>
                                <p class="text-sm text-slate-500">Track Early Settlements, Closures & Credit Notes</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="UI.openSettlementModal()" class="group flex items-center px-4 py-2 bg-brand-600 text-white rounded-lg shadow-lg hover:bg-brand-700 transition hover:-translate-y-0.5">
                                    <i class="fa-solid fa-plus mr-2"></i> Add New
                                </button>
                                <button onclick="UI.exportSettlementCSV()" class="group flex items-center px-4 py-2 bg-white dark:bg-dark-card border border-purple-200 dark:border-purple-900/30 text-purple-600 dark:text-purple-400 rounded-lg shadow-sm hover:shadow-md transition hover:-translate-y-0.5">
                                    <i class="fa-solid fa-file-csv mr-2 group-hover:scale-110 transition-transform"></i>
                                    <span class="font-bold text-xs uppercase tracking-wide">Export</span>
                                </button>
                            </div>
                        </div>

                        <!--Stats Cards-->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="glass-panel p-5 rounded-2xl border-l-4 border-purple-500 shadow-sm relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                    <i class="fa-solid fa-hand-holding-dollar text-6xl text-purple-600"></i>
                                </div>
                                <p class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-1">Early Settlements</p>
                                <h3 class="text-3xl font-bold text-slate-800 dark:text-white">${countType('Early Settlement')}</h3>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl border-l-4 border-blue-500 shadow-sm relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                    <i class="fa-solid fa-folder-closed text-6xl text-blue-600"></i>
                                </div>
                                <p class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-1">Regular Closures</p>
                                <h3 class="text-3xl font-bold text-slate-800 dark:text-white">${countType('Regular Close')}</h3>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl border-l-4 border-amber-500 shadow-sm relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                    <i class="fa-solid fa-file-invoice-dollar text-6xl text-amber-600"></i>
                                </div>
                                <p class="text-xs font-bold text-amber-600 uppercase tracking-wider mb-1">Credit Notes</p>
                                <h3 class="text-3xl font-bold text-slate-800 dark:text-white">${countType('Credit Note')}</h3>
                            </div>
                        </div>

                        <!--Data Table-->
            <div class="glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden border border-slate-200 dark:border-slate-700">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 dark:text-slate-400 uppercase font-bold">
                            <tr>
                                <th class="px-6 py-4 w-10 text-center">
                                    <input type="checkbox" id="select-all-settlements" onchange="UI.selectAll('settlements', ['${allIds.join("','")}'])" class="rounded border-slate-300 cursor-pointer">
                                </th>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4">Territory</th>
                                <th class="px-6 py-4">Customer Code</th>
                                <th class="px-6 py-4">Type</th>
                                <th class="px-6 py-4 text-right">Amount</th>
                                <th class="px-6 py-4">Remarks</th>
                                <th class="px-6 py-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                            ${settlements.map(s => {
                    let badgeClass = '';
                    if (s.type === 'Early Settlement') badgeClass = 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300';
                    else if (s.type === 'Credit Note') badgeClass = 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300';
                    else badgeClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300';

                    return `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                <td class="px-6 py-4 text-center">
                                                     <input type="checkbox" onchange="UI.toggleSelect('settlements', '${s.id}')" data-select-type="settlements" data-id="${s.id}" class="rounded border-slate-300 cursor-pointer">
                                                </td>
                                                <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-400">${s.date}</td>
                                                <td class="px-6 py-4 font-medium text-slate-800 dark:text-white">${s.territoryName}</td>
                                                <td class="px-6 py-4 font-mono font-bold">${s.customerCode}</td>
                                                <td class="px-6 py-4">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${s.type}</span>
                                                </td>
                                                <td class="px-6 py-4 text-right font-mono text-slate-700 dark:text-slate-300">
                                                    ৳${Number(s.amount || 0).toLocaleString()}
                                                </td>
                                                <td class="px-6 py-4 text-slate-500 italic truncate max-w-xs">${s.remarks || '-'}</td>
                                                <td class="px-6 py-4 text-center">
                                                    <button onclick="UI.openSettlementModal('${s.id}')" class="text-slate-400 hover:text-brand-600 transition">
                                                        <i class="fa-solid fa-pen-to-square"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                }).join('')}
                            ${settlements.length === 0 ? '<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400 italic">No records found in the vault.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
                    </div>
            `;
            },

            exportSettlementCSV() {
                const db = Store.get();
                if (db.settlements.length === 0) {
                    alert('No settlement data to export.');
                    return;
                }

                let csv = "Date,Territory,CustomerCode,Type,Amount,Remarks\n";
                db.settlements.forEach(s => {
                    const t = db.territories.find(ter => ter.id === s.territoryId);
                    const tName = t ? t.name : 'Unknown';
                    csv += `${s.date}, "${tName}", "${s.customerCode}", "${s.type}", ${s.amount}, "${s.remarks || ''}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Settlement_Closures_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            renderAdminHistory() {
                const today = new Date();
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry max-w-6xl mx-auto" >
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Global Collection History</h2>
                                <p class="text-sm text-slate-500">Master record of all collections across territories</p>
                            </div>
                            
                            <form onsubmit="UI.updateAdminHistory(event)" class="flex items-center bg-white dark:bg-dark-card p-1.5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                                <div class="px-2 border-r border-slate-100 dark:border-slate-700 mr-2">
                                    <input type="text" name="territorySearch" placeholder="Search Territory..." class="bg-transparent border-none text-xs font-bold text-slate-700 dark:text-slate-300 focus:ring-0 w-32 outline-none">
                                </div>
                                <div class="flex items-center px-2">
                                    <i class="fa-regular fa-calendar text-slate-400 mr-2"></i>
                                    <input type="date" name="startDate" value="${startOfMonth}" class="bg-transparent border-none text-xs font-bold text-slate-700 dark:text-slate-300 focus:ring-0 w-28 outline-none">
                                </div>
                                <span class="text-slate-300">-</span>
                                <div class="flex items-center px-2">
                                    <input type="date" name="endDate" value="${endOfMonth}" class="bg-transparent border-none text-xs font-bold text-slate-700 dark:text-slate-300 focus:ring-0 w-28 outline-none">
                                </div>
                                <button type="submit" class="bg-brand-500 hover:bg-brand-600 text-white p-2 rounded-lg transition shadow-md hover-lift">
                                    <i class="fa-solid fa-filter"></i>
                                </button>
                                <button type="button" onclick="UI.openCollectionModal()" class="ml-2 bg-slate-800 text-white p-2 rounded-lg hover:bg-slate-900 transition shadow-md" title="Add Manual Collection">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </form>
                        </div>

                        <!--Summary Cards-->
                        <div id="admin-history-summary" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                            <!-- Injected by JS -->
                        </div>

                        <!--Table -->
            <div class="glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden border border-slate-200 dark:border-slate-700">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 uppercase font-bold">
                            <tr>
                                <th class="px-6 py-3 w-10 text-center">
                                    <input type="checkbox" id="select-all-history" class="rounded border-slate-300 cursor-pointer">
                                </th>
                                <th class="px-6 py-3">Date</th>
                                <th class="px-6 py-3">Territory</th>
                                <th class="px-6 py-3">Receipt</th>
                                <th class="px-6 py-3">Customer</th>
                                <th class="px-6 py-3">Mode</th>
                                <th class="px-6 py-3 text-right text-slate-400">Regular</th>
                                <th class="px-6 py-3 text-right text-brand-500">Advance</th>
                                <th class="px-6 py-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="admin-history-table-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
                    </div>
            `;

                this.updateAdminHistory(null, startOfMonth, endOfMonth, '');
            },

            updateAdminHistory(e, startOverride, endOverride, searchOverride) {
                if (e) e.preventDefault();

                let start, end, search;
                if (e) {
                    const formData = new FormData(e.target);
                    start = formData.get('startDate');
                    end = formData.get('endDate');
                    search = formData.get('territorySearch');
                } else {
                    start = startOverride;
                    end = endOverride;
                    search = searchOverride || '';
                }

                const db = Store.get();

                // Get all collections joined with territory name
                let filtered = db.collections.map(c => {
                    const t = db.territories.find(ter => ter.id === c.territoryId);
                    return { ...c, territoryName: t ? t.name : 'Unknown' };
                }).filter(c =>
                    c.date >= start &&
                    c.date <= end &&
                    (search === '' || c.territoryName.toLowerCase().includes(search.toLowerCase()))
                ).sort((a, b) => new Date(b.date) - new Date(a.date));

                // Calc Totals
                const totalAmt = filtered.reduce((s, c) => s + parseFloat(c.amount), 0);
                const count = filtered.length;
                const bankAmt = filtered.filter(c => c.mode === 'Bank Transfer').reduce((s, c) => s + parseFloat(c.amount), 0);

                // Update Summary
                // Update Summary
                document.getElementById('admin-history-summary').innerHTML = `
                    <div class="glass-panel p-5 rounded-2xl border-l-4 border-brand-500 shadow-sm relative overflow-hidden group hover-lift">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <i class="fa-solid fa-sack-dollar text-6xl text-brand-600"></i>
                         </div>
                        <p class="text-xs font-bold text-brand-600 uppercase tracking-wider mb-1">Total Collection</p>
                        <h3 class="text-3xl font-bold text-slate-800 dark:text-white">৳ ${Math.round(totalAmt).toLocaleString()}</h3>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl border-l-4 border-blue-500 shadow-sm relative overflow-hidden group hover-lift">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <i class="fa-solid fa-receipt text-6xl text-blue-600"></i>
                        </div>
                        <p class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-1">Transactions</p>
                        <h3 class="text-3xl font-bold text-slate-800 dark:text-white">${count}</h3>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl border-l-4 border-purple-500 shadow-sm relative overflow-hidden group hover-lift">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                             <i class="fa-solid fa-building-columns text-6xl text-purple-600"></i>
                        </div>
                        <p class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-1">Bank Deposit</p>
                        <h3 class="text-3xl font-bold text-slate-800 dark:text-white">৳ ${Math.round(bankAmt).toLocaleString()}</h3>
                    </div>
        `;

                // Update Table
                const tbody = document.getElementById('admin-history-table-body');
                const allIds = filtered.map(c => c.id);

                // Bind Select All event
                const selectAllCheck = document.getElementById('select-all-history');
                if (selectAllCheck) {
                    selectAllCheck.onclick = () => UI.selectAll('history', allIds);
                    selectAllCheck.checked = false; // Reset on re-render
                }

                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr > <td colspan="10" class="px-6 py-12 text-center text-slate-400 italic">No collections found matching criteria.</td></tr > `;
                } else {
                    tbody.innerHTML = filtered.map(c => {
                        const reg = c.regularAmount || (c.advanceAmount ? 0 : c.amount);
                        const adv = c.advanceAmount || 0;
                        return `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition" >
                            <td class="px-6 py-3 text-center">
                                 <input type="checkbox" onchange="UI.toggleSelect('history', '${c.id}')" data-select-type="history" data-id="${c.id}" class="rounded border-slate-300 cursor-pointer">
                            </td>
                            <td class="px-6 py-3 font-mono text-slate-600 dark:text-slate-400 text-xs">${c.date}</td>
                            <td class="px-6 py-3 font-bold text-slate-700 dark:text-slate-300 text-xs">${c.territoryName}</td>
                            <td class="px-6 py-3 font-medium text-slate-800 dark:text-white">#${c.receipt}</td>
                            <td class="px-6 py-3 font-mono text-xs text-brand-600">${c.customerCode || 'N/A'}</td>
                            <td class="px-6 py-3">
                                <span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-slate-100 dark:bg-slate-700 text-slate-500 border border-slate-200 dark:border-slate-600">${c.mode}</span>
                            </td>
                            <td class="px-6 py-3 text-right font-mono text-slate-500 text-xs">${parseFloat(reg).toLocaleString()}</td>
                            <td class="px-6 py-3 text-right font-mono text-brand-500 text-xs">${parseFloat(adv).toLocaleString()}</td>
                            <td class="px-6 py-3 text-right font-mono font-bold text-slate-800 dark:text-white">${parseFloat(c.amount).toLocaleString()}</td>
                        </tr>
            `}).join('');
                }
            },

            // --- OFFICER VIEWS ---
            renderOfficerDashboard() {
                const db = Store.get();
                const linkedTId = this.getCurrentTerritoryId();

                if (!linkedTId) {
                    document.getElementById('views-container').innerHTML = `<div class="p-8 text-center text-slate-500" > Your account is not linked to any Territory Data. Please contact Admin.</div> `;
                    return;
                }

                const metrics = Calc.getMetrics(linkedTId);
                const currentMonth = new Date().toISOString().slice(0, 7);
                const targetData = db.targets.find(t => t.territoryId === linkedTId && t.month === currentMonth) || {};

                // Calculate Today Achievement for the new layout
                const todayAch = metrics.todayProj > 0 ? ((metrics.todayColl / metrics.todayProj) * 100).toFixed(1) : (metrics.todayColl > 0 ? '100+' : '0.0');

                // Calculate Regular vs Advance Split (MTD)
                const mtdCollReg = metrics.rawCollections.reduce((sum, c) => sum + (parseFloat(c.regularAmount) || (parseFloat(c.advanceAmount) ? 0 : parseFloat(c.amount)) || 0), 0);
                const mtdCollAdv = metrics.rawCollections.reduce((sum, c) => sum + (parseFloat(c.advanceAmount) || 0), 0);
                const totalCollSplit = mtdCollReg + mtdCollAdv;
                const regPct = totalCollSplit > 0 ? Math.round((mtdCollReg / totalCollSplit) * 100) : 0;
                const advPct = totalCollSplit > 0 ? Math.round((mtdCollAdv / totalCollSplit) * 100) : 0;

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry mb-6" >
                        <h2 class="text-2xl font-bold">Dashboard</h2>
                        <p class="text-slate-500">${Auth.currentUser.officerName || Auth.currentUser.username}</p>
                    </div>
                    
                    <!--Portfolio Health Strip(Green Theme)-->
                    <div class="animate-entry mb-8 p-1 rounded-xl bg-gradient-to-r from-brand-600 to-blue-500 shadow-lg text-white hover-lift">
                        <div class="flex flex-col md:flex-row divide-y md:divide-y-0 md:divide-x divide-white/20 bg-white/10 backdrop-blur-sm rounded-lg">
                            <div class="flex-1 p-4 text-center">
                                <p class="text-xs uppercase tracking-wider opacity-80 mb-1">Month Start Total OD</p>
                                <p class="text-2xl font-bold font-mono">${parseInt(targetData.totalOd || 0).toLocaleString()}</p>
                            </div>
                            <div class="flex-1 p-4 text-center">
                                <p class="text-xs uppercase tracking-wider opacity-80 mb-1">OD Growth (SPLY)</p>
                                <p class="text-xl font-bold ${parseFloat(targetData.odGrowthSply) > 0 ? 'text-red-200' : 'text-green-200'}">
                                    ${targetData.odGrowthSply || 0}% <i class="fa-solid fa-arrow-${parseFloat(targetData.odGrowthSply) > 0 ? 'up' : 'down'} text-xs"></i>
                                </p>
                            </div>
                            <div class="flex-1 p-4 text-center">
                                <p class="text-xs uppercase tracking-wider opacity-80 mb-1">Per File OD</p>
                                <p class="text-xl font-bold font-mono">${parseInt(targetData.perFileOd || 0).toLocaleString()}</p>
                            </div>
                            <div class="flex-1 p-4 text-center">
                                <p class="text-xs uppercase tracking-wider opacity-80 mb-1">6+ OD Files</p>
                                <p class="text-2xl font-bold">${targetData.sixPlusOdFiles || 0}</p>
                            </div>
                            <div class="flex-1 p-4 text-center">
                                <p class="text-xs uppercase tracking-wider opacity-80 mb-1">6+ Growth (SPLM)</p>
                                <p class="text-xl font-bold ${parseFloat(targetData.sixPlusOdGrowthSplm) > 0 ? 'text-red-200' : 'text-green-200'}">
                                    ${targetData.sixPlusOdGrowthSplm || 0}%
                                </p>
                            </div>
                        </div>
                    </div>

                    <!--RPI & OFFROAD STATUS BANNER-->
                    <div class="animate-entry mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-3 p-6 rounded-2xl border ${Calc.getRPIBg(metrics.rpi)} flex items-center justify-between shadow-sm hover-lift relative overflow-hidden group">
                           <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4 group-hover:translate-x-2 group-hover:-translate-y-2 transition-transform">
                                <i class="fa-solid fa-bolt-lightning text-8xl"></i>
                           </div>
                           <div class="relative z-10">
                                <h3 class="text-lg font-black text-slate-800 dark:text-white tracking-tight">Recovery Performance Index (RPI)</h3>
                                <p class="text-xs uppercase font-bold opacity-60 tracking-widest">Efficiency Multiplier Index</p>
                            </div>
                            <div class="text-5xl font-black ${Calc.getRPIColor(metrics.rpi)} relative z-10">${metrics.rpi}</div>
                        </div>

                        <div onclick="Router.navigate('offroad-monitor')" class="cursor-pointer p-6 rounded-2xl border border-rose-100 dark:border-rose-900/30 bg-rose-50/50 dark:bg-rose-900/10 flex flex-col justify-center shadow-sm hover-lift relative overflow-hidden group">
                            <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4 group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-car-burst text-6xl text-rose-600"></i>
                            </div>
                            <p class="text-[10px] uppercase font-bold text-rose-500 mb-1">Active Offroad</p>
                            <h3 class="text-3xl font-black text-rose-600">${db.offroad_vehicles.filter(v => v.territoryId === linkedTId && v.status === 'Active').length}</h3>
                            <button class="mt-2 text-[10px] font-bold text-rose-600 border-b border-rose-200 w-fit hover:border-rose-600 transition-all">VIEW TRACKER <i class="fa-solid fa-chevron-right ml-1"></i></button>
                        </div>
                    </div>

                    <!--COMPACT METRIC TABLE-->
                    <div class="animate-entry mb-6 overflow-hidden rounded-xl shadow-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-dark-card">
                        <table class="w-full text-xs text-left border-collapse">
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                <!-- Row 1 -->
                                <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700 w-1/4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Total Target</span>
                                            <span class="font-bold text-slate-800 dark:text-white">${parseInt(metrics.targetAmt).toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700 w-1/4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Total Files</span>
                                            <span class="font-bold text-slate-800 dark:text-white">${metrics.targetFiles}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700 w-1/4">
                                         <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Today Proj</span>
                                            <span class="font-bold text-slate-800 dark:text-white">${parseInt(metrics.todayProj).toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 w-1/4">
                                         <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Remaining</span>
                                            <span class="font-bold text-amber-600">${parseInt(metrics.remainingAmt).toLocaleString()}</span>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Row 2 -->
                                <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Till Date Coll</span>
                                            <span class="font-bold text-emerald-600">${parseInt(metrics.mtdColl).toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Coll Files</span>
                                            <span class="font-bold text-emerald-600">${metrics.uniquePaidCodes}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Collection</span>
                                            <span class="font-bold text-emerald-600">${parseInt(metrics.todayColl).toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Daily Req</span>
                                            <span class="font-bold text-red-600">${parseInt(Math.round(metrics.rdrr)).toLocaleString()}</span>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Row 3 -->
                                <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Ach % (MTD)</span>
                                            <span class="font-bold text-indigo-600">${metrics.achievement}%</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                         <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Uncollected</span>
                                            <span class="font-bold text-rose-600">${metrics.tillDateNonPayFiles}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                         <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Ach % (Today)</span>
                                            <span class="font-bold text-fuchsia-600">${todayAch}%</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">Run Rate</span>
                                            <span class="font-bold text-brand-600">${metrics.rpi} RPI</span>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Row 4 (LMNP Recovery) -->
                                <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition bg-slate-50/50 dark:bg-slate-800/20">
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">LM NP Target</span>
                                            <span class="font-bold text-slate-800 dark:text-white">${parseInt(metrics.lmNpTargetAmt).toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">LM NP Rec</span>
                                            <span class="font-bold text-emerald-600">${parseInt(metrics.mtdLmNpColl).toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5 border-r border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">NP Files (T)</span>
                                            <span class="font-bold text-slate-800 dark:text-white">${metrics.lmNpTargetFiles}</span>
                                        </div>
                                    </td>
                                    <td class="p-2.5">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-500 font-bold uppercase tracking-tight">NP Files (R)</span>
                                            <span class="font-bold text-emerald-600">${metrics.mtdLmNpFiles}</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!--COLLECTION MIX(Regular vs Advance) - NEW CREATIVE SECTION-->
                    <div class="animate-entry mb-8 p-3 rounded-xl bg-white dark:bg-dark-card border border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="flex justify-between items-end mb-2 px-1">
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full bg-slate-500"></span>
                                <div class="leading-none">
                                    <p class="text-[10px] uppercase font-bold text-slate-400">Regular</p>
                                    <p class="text-sm font-bold text-slate-700 dark:text-slate-200">${parseInt(mtdCollReg).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-right">
                                <div class="leading-none">
                                    <p class="text-[10px] uppercase font-bold text-brand-500">Advance</p>
                                    <p class="text-sm font-bold text-brand-600">${parseInt(mtdCollAdv).toLocaleString()}</p>
                                </div>
                                <span class="w-2.5 h-2.5 rounded-full bg-brand-500"></span>
                            </div>
                        </div>
                        
                        <div class="relative h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden flex">
                            <div class="h-full bg-slate-500 relative group transition-all duration-700" style="width: ${regPct}%"></div>
                            <div class="h-full bg-brand-500 relative group transition-all duration-700" style="width: ${advPct}%"></div>
                        </div>
                        
                        <div class="flex justify-between mt-1 px-1 text-[9px] font-bold text-slate-400">
                            <span>${regPct}%</span>
                            <span>${advPct}%</span>
                        </div>
                    </div>

                    <!--CHARTS ROW-->
                    <div class="animate-entry grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="glass-panel p-5 rounded-xl shadow dark:bg-dark-card hover-lift">
                            <h4 class="font-bold mb-4 text-sm text-slate-500 uppercase">Collection Trend (Daily)</h4>
                            <div class="relative h-64">
                                <canvas id="chart-trend"></canvas>
                            </div>
                        </div>
                        <div class="glass-panel p-5 rounded-xl shadow dark:bg-dark-card hover-lift">
                            <h4 class="font-bold mb-4 text-sm text-slate-500 uppercase">Projection vs Actual</h4>
                            <div class="relative h-64">
                                <canvas id="chart-proj-act"></canvas>
                            </div>
                        </div>
                    </div>

                    <!--RECENT TRANSACTIONS-->
            <div class="animate-entry glass-panel rounded-xl shadow dark:bg-dark-card overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 dark:text-white">Today's Collections</h3>
                    <button onclick="Router.navigate('officer-collection')" class="text-xs bg-brand-600 text-white px-3 py-1 rounded hover:bg-brand-700 hover-lift">New Entry</button>
                </div>
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 uppercase">
                        <tr>
                            <th class="px-6 py-3">Receipt</th>
                            <th class="px-6 py-3">Breakdown</th>
                            <th class="px-6 py-3">Mode</th>
                            <th class="px-6 py-3 text-right">Total</th>
                            <th class="px-6 py-3"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${metrics.rawCollections.filter(c => c.date === new Date().toISOString().split('T')[0]).map(c => `
                                    <tr class="interactive-row border-b border-slate-100 dark:border-slate-700">
                                        <td class="px-6 py-3 font-medium">#${c.receipt}<br><span class="text-xs text-slate-400">${c.customerCode || 'N/A'}</span></td>
                                        <td class="px-6 py-3">
                                            <div class="text-xs">
                                                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> <span class="text-slate-500">Reg:</span> <span class="font-bold text-slate-700 dark:text-slate-300">${c.regularAmount ? parseFloat(c.regularAmount).toLocaleString() : '-'}</span></div>
                                                <div class="flex items-center gap-1 mt-0.5"><span class="w-2 h-2 rounded-full bg-brand-400"></span> <span class="text-slate-500">Adv:</span> <span class="font-bold text-brand-600">${c.advanceAmount ? parseFloat(c.advanceAmount).toLocaleString() : '-'}</span></div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-3"><span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-700">${c.mode}</span></td>
                                        <td class="px-6 py-3 text-right font-bold">${parseFloat(c.amount).toLocaleString()}</td>
                                        <td class="px-6 py-3 text-right">
                                            <span class="text-xs text-slate-400 italic">Locked</span>
                                        </td>
                                    </tr>
                                `).join('')}
                        ${metrics.rawCollections.filter(c => c.date === new Date().toISOString().split('T')[0]).length === 0 ? '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-400">No collections today</td></tr>' : ''}
                    </tbody>
                </table>
            </div>
        `;

                // Render Charts
                const dailyData = this.getDailyTrendData(linkedTId);
                setTimeout(() => {
                    Charts.renderLine('chart-trend', dailyData.labels, dailyData.data);
                    Charts.renderBar('chart-proj-act', ['Projected', 'Actual'], [metrics.todayProj, metrics.todayColl]);
                }, 100);
            },

            renderOfficerOffroadTracker(viewMode = 'active') {
                const db = Store.get();
                const linkedTId = this.getCurrentTerritoryId();

                if (!linkedTId) {
                    document.getElementById('views-container').innerHTML = `<div class="p-8 text-center text-slate-500">Your account is not linked to any Territory Data. Please contact Admin.</div>`;
                    return;
                }

                // Get Filter
                const fReason = document.getElementById('officer-offroad-filter-reason')?.value || '';

                const offroadData = db.offroad_vehicles.filter(v => v.territoryId === linkedTId);

                // Filter for Display
                const displayData = (viewMode === 'active'
                    ? offroadData.filter(v => v.status === 'Active')
                    : offroadData.filter(v => v.status === 'Solved'))
                    .filter(v => !fReason || v.reason === fReason)
                    .sort((a, b) => {
                        if (viewMode === 'active') return new Date(b.inDate) - new Date(a.inDate);
                        return new Date(b.solveDate) - new Date(a.solveDate);
                    });

                // Dashboard Counts (based on filtered data)
                const total = displayData.length;
                const captured = displayData.filter(v => v.reason === 'Capture').length;
                const accident = displayData.filter(v => v.reason === 'Accident').length;
                const thana = displayData.filter(v => v.reason === 'Thana/Police station').length;
                const others = displayData.filter(v => v.reason === 'Lost or untraceable').length;

                document.getElementById('views-container').innerHTML = `
                    <div class="animate-entry max-w-6xl mx-auto">
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Offroad Monitor</h2>
                                <p class="text-sm text-slate-500">Manage recovery status and vehicle incidents</p>
                            </div>
                            
                            <div class="flex flex-wrap items-center gap-3">
                                <div class="bg-slate-200 dark:bg-slate-700 p-1 rounded-lg inline-flex mr-2">
                                    <button onclick="UI.renderOfficerOffroadTracker('active')" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all ${viewMode === 'active' ? 'bg-white dark:bg-slate-600 text-brand-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}">
                                        Active
                                    </button>
                                    <button onclick="UI.renderOfficerOffroadTracker('archive')" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all ${viewMode === 'archive' ? 'bg-white dark:bg-slate-600 text-brand-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}">
                                        Archive
                                    </button>
                                </div>

                                <button onclick="UI.openOffroadModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg shadow-lg font-bold transition flex items-center text-sm">
                                    <i class="fa-solid fa-plus mr-2"></i> Report New
                                </button>
                            </div>
                        </div>

                        <!-- Mini Dashboard -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                            <div class="glass-panel p-4 rounded-2xl border-b-4 border-slate-500/50 hover-lift">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total ${viewMode === 'active' ? 'Active' : 'Solved'}</p>
                                <p class="text-2xl font-black text-slate-800 dark:text-white">${total}</p>
                            </div>
                            <div class="glass-panel p-4 rounded-2xl border-l-4 border-orange-500 hover-lift bg-orange-50/10">
                                <p class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-1">Captured</p>
                                <p class="text-2xl font-black text-slate-800 dark:text-white">${captured}</p>
                            </div>
                            <div class="glass-panel p-4 rounded-2xl border-l-4 border-blue-500 hover-lift bg-blue-50/10">
                                <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">Accident</p>
                                <p class="text-2xl font-black text-slate-800 dark:text-white">${accident}</p>
                            </div>
                            <div class="glass-panel p-4 rounded-2xl border-l-4 border-indigo-500 hover-lift bg-indigo-50/10">
                                <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Thana</p>
                                <p class="text-2xl font-black text-slate-800 dark:text-white">${thana}</p>
                            </div>
                            <div class="glass-panel p-4 rounded-2xl border-l-4 border-rose-500 hover-lift bg-rose-50/10">
                                <p class="text-[10px] font-black text-rose-500 uppercase tracking-widest mb-1">Others</p>
                                <p class="text-2xl font-black text-slate-800 dark:text-white">${others}</p>
                            </div>
                        </div>

                        <!-- Search & Filter -->
                        <div class="mb-4 flex gap-4">
                            <div class="flex-1 relative">
                                <i class="fa-solid fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                <select id="officer-offroad-filter-reason" onchange="UI.renderOfficerOffroadTracker('${viewMode}')" class="w-full pl-9 pr-4 py-2 bg-white dark:bg-dark-card border border-slate-200 dark:border-slate-700 rounded-xl text-xs font-bold outline-none focus:border-brand-500 shadow-sm appearance-none">
                                    <option value="">Filter by Incident Reason: All</option>
                                    <option value="Accident" ${fReason === 'Accident' ? 'selected' : ''}>Accident</option>
                                    <option value="Capture" ${fReason === 'Capture' ? 'selected' : ''}>Capture</option>
                                    <option value="Thana/Police station" ${fReason === 'Thana/Police station' ? 'selected' : ''}>Thana/Police station</option>
                                    <option value="Lost or untraceable" ${fReason === 'Lost or untraceable' ? 'selected' : ''}>Others/Lost</option>
                                </select>
                            </div>
                        </div>

                        <div class="glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden border border-slate-200 dark:border-slate-700">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 dark:bg-slate-800 text-[10px] text-slate-500 uppercase font-black tracking-widest border-b dark:border-slate-700">
                                        <tr>
                                            <th class="px-6 py-4">In Date</th>
                                            ${viewMode === 'archive' ? '<th class="px-6 py-4">Release Date</th>' : ''}
                                            <th class="px-6 py-4">Vehicle Details</th>
                                            <th class="px-6 py-4">Incident Type</th>
                                            <th class="px-6 py-4">Location</th>
                                            <th class="px-6 py-4">Remarks</th>
                                            ${viewMode === 'active' ? '<th class="px-6 py-4 text-center">Action</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${displayData.map(v => `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                <td class="px-6 py-4 font-mono text-xs text-slate-500">${v.inDate}</td>
                                                ${viewMode === 'archive' ? `<td class="px-6 py-4 font-mono text-xs text-green-600 dark:text-green-400 font-bold">${v.solveDate || '-'}</td>` : ''}
                                                <td class="px-6 py-4">
                                                    <div class="font-bold text-slate-800 dark:text-white font-mono uppercase">${v.customerCode || 'N/A'}</div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase shrink-0 ${this.getOffroadBadgeColor(v.reason)}">
                                                        <i class="fa-solid ${this.getOffroadIcon(v.reason)} mr-1"></i> ${v.reason}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-xs">${v.location || 'N/A'}</td>
                                                <td class="px-6 py-4 text-xs italic text-slate-500">"${v.remarks}"</td>
                                                ${viewMode === 'active' ? `
                                                <td class="px-6 py-4 text-center">
                                                    <button onclick="UI.resolveOffroad('${v.id}')" class="px-3 py-1.5 bg-green-50 text-green-600 hover:bg-green-600 hover:text-white rounded-md text-xs font-bold transition-all border border-green-200">
                                                        <i class="fa-solid fa-check mr-1"></i> Release
                                                    </button>
                                                </td>` : ''}
                                            </tr>
                                        `).join('')}
                                        ${displayData.length === 0 ? `<tr><td colspan="${viewMode === 'active' ? 6 : 7}" class="px-6 py-12 text-center text-slate-400 italic">No ${viewMode} incidents found.</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderProjectionForm() {
                const hour = new Date().getHours();
                // Check if time is >= 10:00 AM
                let isLate = hour >= 10;

                const db = Store.get();
                const today = new Date().toISOString().split('T')[0];

                // Resolve tId
                const tId = this.getCurrentTerritoryId();

                // Check for Admin Unlock
                if (isLate && db.unlocks && db.unlocks[tId]) {
                    if (db.unlocks[tId] > Date.now()) {
                        isLate = false; // Override lock if unlock timestamp is in future
                    }
                }

                const existing = db.projections.find(p => p.territoryId === tId && p.date === today);
                const existingRegular = existing ? (existing.regularAmount || existing.amount) : '';
                const existingAdvance = existing ? (existing.advanceAmount || '') : '';

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry max-w-xl mx-auto mt-10" >
                <div class="glass-panel p-8 rounded-2xl shadow-xl dark:bg-dark-card border-t-4 ${isLate ? 'border-red-500' : 'border-brand-500'}">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 rounded-full ${isLate ? 'bg-red-100 text-red-600' : 'bg-brand-100 text-brand-600'} flex items-center justify-center text-xl mr-4">
                            <i class="fa-regular fa-clock"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Morning Projection</h2>
                            <p class="text-sm ${isLate ? 'text-red-500' : 'text-slate-500'}">
                                ${isLate ? 'Submission time (10:00 AM) has passed.' : 'Submit before 10:00 AM'}
                            </p>
                        </div>
                    </div>

                    ${isLate && !existing ? `<div class="p-4 bg-red-50 text-red-700 rounded-lg mb-4 flex items-center"><i class="fa-solid fa-lock mr-2"></i> The projection window is closed. Contact Admin to unlock.</div>` : ''}

                    <form id="projection-form" onsubmit="UI.handleProjectionSubmit(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Today's Projection Amount (Total)</label>
                                    <div class="relative group">
                                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-brand-500 group-focus-within:scale-110 transition-transform">
                                            <i class="fa-solid fa-bangladeshi-taka-sign"></i>
                                        </span>
                                        <input type="number" id="proj-amount" value="${existing ? existing.amount : ''}" 
                                            ${isLate ? 'disabled' : ''} 
                                            class="w-full pl-11 pr-4 py-4 rounded-xl border border-slate-200 dark:border-slate-700 dark:bg-slate-800/50 focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 outline-none transition-all text-lg font-bold font-mono" 
                                            placeholder="Enter total amount..." required>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Expected Collection Files</label>
                                    <div class="relative group">
                                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-blue-500 group-focus-within:scale-110 transition-transform">
                                            <i class="fa-solid fa-file-invoice"></i>
                                        </span>
                                        <input type="number" id="proj-files" value="${existing ? existing.fileCount : ''}" 
                                            ${isLate ? 'disabled' : ''} 
                                            class="w-full pl-11 pr-4 py-4 rounded-xl border border-slate-200 dark:border-slate-700 dark:bg-slate-800/50 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all text-lg font-bold font-mono" 
                                            placeholder="Enter number of files..." required>
                                    </div>
                                </div>
                            </div>

                                    ${!isLate ? `
                                        <div class="pt-4">
                                            <button type="submit" class="w-full bg-gradient-to-r from-brand-600 to-emerald-600 hover:from-brand-700 hover:to-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg border border-brand-500/20 transition transform active:scale-[0.98] flex items-center justify-center gap-2 group">
                                                <i class="fa-solid fa-paper-plane group-hover:-translate-y-1 group-hover:translate-x-1 transition-transform"></i>
                                                ${existing ? 'Update Today\'s Projection' : 'Submit Morning Projection'}
                                            </button>
                                        </div>
                                    ` : ''}
                        </div>
                    </form>
                </div>
                    </div>
            `;
            },

            renderCollectionForm() {
                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry max-w-xl mx-auto mt-6" >
                <div class="glass-panel p-8 rounded-2xl shadow-xl dark:bg-dark-card relative overflow-hidden">
                    <!-- Decorative bg element -->
                    <div class="absolute -top-12 -right-12 w-40 h-40 bg-brand-500/5 rounded-full blur-3xl pointer-events-none"></div>

                    <div class="flex justify-between items-start mb-8 relative z-10">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                                <span class="w-1.5 h-6 bg-brand-500 rounded-full"></span>
                                New Collection
                            </h2>
                            <p class="text-xs text-slate-500 dark:text-slate-400 ml-4 mt-1">Enter daily collection details</p>
                        </div>
                        <button onclick="Router.navigate('officer-dashboard')" class="group w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-700/50 hover:bg-rose-50 dark:hover:bg-rose-900/20 border border-slate-100 dark:border-slate-600 flex items-center justify-center transition-all duration-300 hover:rotate-90 hover:shadow-md">
                            <i class="fa-solid fa-xmark text-slate-400 group-hover:text-rose-500 text-lg transition-colors"></i>
                        </button>
                    </div>

                    <form id="collection-form" onsubmit="UI.handleCollectionSubmit(event)" class="space-y-4 relative z-10">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date (Locked)</label>
                            <input type="date" id="coll-date" class="w-full p-4 md:p-3 rounded-xl border bg-slate-100 text-slate-500 dark:bg-slate-700 dark:border-slate-600 cursor-not-allowed" disabled>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer Code</label>
                            <input type="text" id="coll-code" class="w-full p-4 md:p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-brand-500" placeholder="e.g., C-1052" required>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Money Receipt No</label>
                            <input type="text" id="coll-receipt" class="w-full p-4 md:p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-brand-500" required>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Regular Amount</label>
                                <input type="number" id="coll-reg-amount" class="w-full p-4 md:p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-brand-500 text-lg font-bold text-slate-700 dark:text-slate-200" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Advance Amount</label>
                                <input type="number" id="coll-adv-amount" class="w-full p-4 md:p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-brand-500 text-lg font-bold text-slate-700 dark:text-slate-200" placeholder="0.00">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Payment Mode</label>
                                <select id="coll-mode" class="w-full p-4 md:p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-brand-500 bg-white dark:bg-slate-800">
                                    <option>Bank Transfer</option>
                                    <option>bKash</option>
                                    <option>Cheque</option>
                                    <option>Cash</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center space-x-3 p-4 border rounded-xl w-full cursor-pointer hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-800 transition">
                                    <input type="checkbox" id="coll-lmnp" class="w-6 h-6 text-brand-600 rounded focus:ring-brand-500">
                                        <span class="text-sm font-medium">Last Month NP Recovery?</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg mt-4 transition transform active:scale-95 hover-lift text-lg">
                            Save Entry
                        </button>
                    </form>
                </div>
                    </div>
            `;
                document.getElementById('coll-date').valueAsDate = new Date();
            },

            // --- DATA ENTRY PANEL ---
            renderDataEntry() {
                const db = Store.get();
                const currentMonth = new Date().toISOString().slice(0, 7);
                let displayData = [];

                // Load existing data or create dummy rows if empty
                if (db.territories.length <= 2) {
                    for (let i = 1; i <= 20; i++) {
                        const tId = `t${100 + i} `;
                        const part = i % 2 === 0 ? 'B' : 'A';
                        const existingT = db.territories.find(t => t.name === `Territory ${i} `);
                        displayData.push({
                            id: existingT ? existingT.id : tId,
                            name: existingT ? existingT.name : `Region ${i.toString().padStart(2, '0')} `,
                            part: existingT ? existingT.part : part,
                            targetFiles: 150,
                            projFiles: 140,
                            targetAmount: 500000,
                            projReg: 450000,
                            projAdv: 50000,
                            lmNpTargetAmount: 50000,
                            lmNpTargetFiles: 20,
                            totalOd: 120000,
                            odGrowthSply: 5.2,
                            perFileOd: 2500,
                            sixPlusOdFiles: 12,
                            sixPlusOdGrowthSplm: -1.5
                        });
                    }
                } else {
                    displayData = db.territories.map(t => {
                        const target = db.targets.find(tg => tg.territoryId === t.id && tg.month === currentMonth) || {};
                        return {
                            id: t.id,
                            name: t.name,
                            part: t.part,
                            targetFiles: target.files || 0,
                            projFiles: target.projFiles || 0,
                            targetAmount: target.amount || 0,
                            projReg: target.projReg || 0,
                            projAdv: target.projAdv || 0,
                            lmNpTargetAmount: target.lmNpTargetAmount || 0,
                            lmNpTargetFiles: target.lmNpTargetFiles || 0,
                            totalOd: target.totalOd || 0,
                            odGrowthSply: target.odGrowthSply || 0,
                            perFileOd: target.perFileOd || 0,
                            sixPlusOdFiles: target.sixPlusOdFiles || 0,
                            sixPlusOdGrowthSplm: target.sixPlusOdGrowthSplm || 0
                        };
                    });
                }

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry flex flex-col h-[calc(100vh-140px)]" >
                        <div class="mb-6 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Data Entry Setup</h2>
                                <p class="text-sm text-slate-500">Monthly Targets & Initial Projections</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="UI.downloadTargetTemplate()" class="flex items-center px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition text-sm font-medium hover-lift">
                                    <i class="fa-solid fa-download mr-2 text-slate-500"></i> Template
                                </button>
                                
                                <label class="flex items-center px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition text-sm font-medium cursor-pointer hover-lift">
                                    <i class="fa-solid fa-upload mr-2 text-brand-600"></i> Import CSV
                                    <input type="file" class="hidden" accept=".csv" onchange="UI.handleCSVUpload(event)">
                                </label>

                                <button onclick="UI.saveBulkData()" class="flex items-center px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 shadow-lg transition transform active:scale-95 text-sm font-bold hover-lift">
                                    <i class="fa-solid fa-save mr-2"></i> Save All Changes
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden flex flex-col border border-slate-200 dark:border-slate-700">
                            <div class="overflow-auto flex-1">
                                <table class="w-full text-sm text-left border-collapse" id="data-entry-table">
                                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 uppercase sticky top-0 z-10 font-bold text-xs">
                                        <!-- Top Group Header -->
                                        <tr>
                                            <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-center" colspan="12"></th> <!-- Spacer for existing cols -->
                                            <th class="p-3 border-b border-l border-slate-200 dark:border-slate-700 bg-brand-50 dark:bg-brand-900/30 text-center text-brand-700 dark:text-brand-300 tracking-widest" colspan="5">Month First Status</th>
                                            <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-center"></th>
                                        </tr>
                                        <!-- Column Headers -->
                                        <tr>
                                            <th class="p-3 border-b dark:border-slate-700 w-12 text-center">#</th>
                                            <th class="p-3 border-b dark:border-slate-700 w-20">Part</th>
                                            <th class="p-3 border-b dark:border-slate-700 min-w-[150px]">Territory Name</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-blue-50 dark:bg-blue-900/20 w-24">Total Files</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-blue-50 dark:bg-blue-900/20 w-24">Proj Files</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-green-50 dark:bg-green-900/20 w-32">Total EMI</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-green-50 dark:bg-green-900/20 w-32">Proj (Reg)</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-green-50 dark:bg-green-900/20 w-32">Proj (Adv)</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-slate-200 dark:bg-slate-700 w-32 font-bold">Total Proj</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-rose-50 dark:bg-rose-900/20 w-32">LM NP Amt</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-rose-50 dark:bg-rose-900/20 w-24">LM NP Files</th>
                                            
                                            <!-- New Columns -->
                                            <th class="p-3 border-b border-l border-slate-200 dark:border-slate-700 bg-brand-50/50 dark:bg-brand-900/10 w-28">Total OD</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-brand-50/50 dark:bg-brand-900/10 w-28">OD Growth SPLY</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-brand-50/50 dark:bg-brand-900/10 w-28">Per File OD</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-brand-50/50 dark:bg-brand-900/10 w-24">6+ OD Files</th>
                                            <th class="p-3 border-b dark:border-slate-700 bg-brand-50/50 dark:bg-brand-900/10 w-28">6+ OD Growth SPLM</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${displayData.map((row, index) => {
                    const totalProj = (parseFloat(row.projReg) || 0) + (parseFloat(row.projAdv) || 0);
                    return `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition" data-id="${row.id || 'new'}">
                                                <td class="p-2 text-center text-slate-400 text-xs">${index + 1}</td>
                                                <td class="p-1"><select name="part" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center"><option value="A" ${row.part === 'A' ? 'selected' : ''}>A</option><option value="B" ${row.part === 'B' ? 'selected' : ''}>B</option></select></td>
                                                <td class="p-1"><input type="text" name="name" value="${row.name}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-medium"></td>
                                                <td class="p-1"><input type="number" name="targetFiles" value="${row.targetFiles}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                                                <td class="p-1"><input type="number" name="projFiles" value="${row.projFiles}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                                                <td class="p-1"><input type="number" name="targetAmount" value="${row.targetAmount}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-blue-600"></td>
                                                <td class="p-1"><input type="number" name="projReg" value="${row.projReg}" oninput="UI.calcRowTotal(this)" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                                                <td class="p-1"><input type="number" name="projAdv" value="${row.projAdv}" oninput="UI.calcRowTotal(this)" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                                                <td class="p-1"><input type="number" name="totalProj" value="${totalProj}" readonly class="w-full p-2 bg-slate-50 dark:bg-slate-800 border-none text-right font-mono font-bold text-slate-500 cursor-default"></td>
                                                <td class="p-1"><input type="number" name="lmNpTargetAmount" value="${row.lmNpTargetAmount}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-600"></td>
                                                <td class="p-1"><input type="number" name="lmNpTargetFiles" value="${row.lmNpTargetFiles}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                                                
                                                <!-- New Inputs -->
                                                <td class="p-1 border-l border-slate-100 dark:border-slate-700"><input type="number" name="totalOd" value="${row.totalOd}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-brand-600 dark:text-brand-400"></td>
                                                <td class="p-1"><input type="number" name="odGrowthSply" value="${row.odGrowthSply}" step="0.01" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                                                <td class="p-1"><input type="number" name="perFileOd" value="${row.perFileOd}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                                                <td class="p-1"><input type="number" name="sixPlusOdFiles" value="${row.sixPlusOdFiles}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                                                <td class="p-1"><input type="number" name="sixPlusOdGrowthSplm" value="${row.sixPlusOdGrowthSplm}" step="0.01" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>

                                                <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
                                            </tr>`;
                }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="p-3 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 flex justify-between">
                                <button onclick="UI.addEmptyDataRow()" class="text-brand-600 hover:text-brand-700 font-bold">+ Add Row</button>
                            </div>
                        </div>
                    </div>
            `;
            },

            // --- USER MANAGEMENT ---
            renderUserManagement() {
                const db = Store.get();

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry flex flex-col h-[calc(100vh-140px)]" >
                        <div class="mb-6 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">User Management</h2>
                                <p class="text-sm text-slate-500">Manage Officers & Login Credentials</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="UI.downloadUserTemplate()" class="flex items-center px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition text-sm font-medium hover-lift">
                                    <i class="fa-solid fa-download mr-2 text-slate-500"></i> Download Template
                                </button>
                                <label class="flex items-center px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition text-sm font-medium cursor-pointer hover-lift">
                                    <i class="fa-solid fa-file-csv mr-2 text-brand-600"></i> Import Users CSV
                                    <input type="file" class="hidden" accept=".csv" onchange="UI.handleUserCSV(event)">
                                </label>
                                <button onclick="UI.saveUsers()" class="px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 shadow-lg font-bold hover-lift">
                                    <i class="fa-solid fa-save mr-2"></i> Save Users
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden flex flex-col border border-slate-200 dark:border-slate-700">
                             <div class="overflow-auto flex-1">
                                <table class="w-full text-sm text-left border-collapse" id="user-mgmt-table">
                                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 uppercase sticky top-0 z-10 font-bold text-xs">
                                        <tr>
                                            <th class="p-3 border-b dark:border-slate-700 w-12 text-center">#</th>
                                            <th class="p-3 border-b dark:border-slate-700">Territory Name (Username)</th>
                                            <th class="p-3 border-b dark:border-slate-700">Officer Name</th>
                                            <th class="p-3 border-b dark:border-slate-700">Employee ID (Password)</th>
                                            <th class="p-3 border-b dark:border-slate-700 text-center w-24">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${db.users.filter(u => u.role === 'officer').map((u, i) => `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                <td class="p-2 text-center text-slate-400 text-xs">${i + 1}</td>
                                                <td class="p-1"><input type="text" name="username" value="${u.username}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-medium"></td>
                                                <td class="p-1"><input type="text" name="officerName" value="${u.officerName || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                                <td class="p-1"><input type="text" name="password" value="${u.password}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-mono text-slate-600 dark:text-slate-400"></td>
                                                <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="p-3 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 flex justify-between">
                                <button onclick="UI.addUserRow()" class="text-brand-600 hover:text-brand-700 font-bold">+ Add Officer</button>
                            </div>
                        </div>
                    </div>
            `;
            },

            // --- SELECTION & BULK ACTIONS HELPERS ---
            selection: { type: null, ids: new Set() },

            _injectFloatingDockCSS() {
                if (document.getElementById('floating-dock-style')) return;
                const style = document.createElement('style');
                style.id = 'floating-dock-style';
                style.textContent = `
                .floating-dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px); /* Start off-screen */
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s ease-out;
            z-index: 1000;
        }
                    .floating-dock.visible {
            transform: translateX(-50%) translateY(0); /* Slide into view */
            opacity: 1;
            visibility: visible;
        }
        `;
                document.head.appendChild(style);
            },

            toggleSelect(type, id) {
                if (this.selection.type !== type) {
                    this.selection.type = type;
                    this.selection.ids.clear();
                }
                if (this.selection.ids.has(id)) this.selection.ids.delete(id);
                else this.selection.ids.add(id);
                this.renderDock();
                this.updateCheckboxes(type);
            },

            selectAll(type, allIds) {
                this.selection.type = type;
                if (this.selection.ids.size === allIds.length) {
                    this.selection.ids.clear();
                } else {
                    allIds.forEach(id => this.selection.ids.add(id));
                }
                this.renderDock();
                this.updateCheckboxes(type);
            },

            updateCheckboxes(type) {
                document.querySelectorAll(`input[data-select-type="${type}"]`).forEach(cb => {
                    const id = cb.getAttribute('data-id');
                    cb.checked = this.selection.ids.has(id);
                });
                const master = document.getElementById(`select-all-${type}`);
                if (master) master.checked = this.selection.ids.size > 0; // Simple indeterminate/checked state
            },

            renderDock() {
                this._injectFloatingDockCSS(); // Ensure CSS is injected
                let dock = document.getElementById('floating-dock');
                if (!dock) {
                    dock = document.createElement('div');
                    dock.id = 'floating-dock';
                    dock.className = 'floating-dock glass-panel px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-4 border border-slate-200 dark:border-slate-600 bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl';
                    document.body.appendChild(dock);
                }

                if (this.selection.ids.size === 0) {
                    dock.classList.remove('visible');
                    return;
                }

                dock.innerHTML = `
            <div class="flex items-center border-r border-slate-300 dark:border-slate-600 pr-4 mr-2" >
                        <span class="bg-brand-600 text-white text-xs font-bold px-2 py-1 rounded-full mr-2">${this.selection.ids.size}</span>
                        <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Selected</span>
                    </div>
                    <div class="flex items-center gap-2">
                         ${this.selection.type !== 'vehicle_performance' ? `
                        <button onclick="UI.bulkEdit('${this.selection.type}')" class="p-2 text-slate-500 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition" title="Edit Selected">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>` : ''} 
                        <button onclick="UI.bulkDelete('${this.selection.type}')" class="p-2 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete Selected">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    <button onclick="UI.clearSelection()" class="ml-2 text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
        `;

                // Allow reflow
                setTimeout(() => dock.classList.add('visible'), 10);
            },

            clearSelection() {
                this.selection.ids.clear();
                this.renderDock();
                this.updateCheckboxes(this.selection.type);
            },

            async bulkDelete(type) {
                if (!confirm(`Delete ${this.selection.ids.size} items ? This cannot be undone.`)) return;

                // Map selection types to DB collections
                const map = {
                    'vehicle_performance': 'vehicle_performance',
                    'offroad': 'offroad_vehicles',
                    'settlements': 'settlements',
                    'history': 'collections',
                    'projections': 'projections'
                };

                await Store.deleteMany(map[type], Array.from(this.selection.ids));
                this.clearSelection();

                // Refresh Views
                if (type === 'vehicle_performance') UI.renderAdminVehiclePerf();
                if (type === 'offroad') UI.renderAdminOffroadView();
                if (type === 'settlements') UI.renderAdminSettlementsView();
                if (type === 'history') UI.renderAdminHistory();
                if (type === 'projections') UI.renderAdminProjections();

                UI.showSuccess('Items deleted successfully');
            },

            bulkEdit(type) {
                if (this.selection.ids.size > 1) {
                    alert("Bulk edit is not supported yet. Please select one item to edit.");
                    return;
                }
                const id = Array.from(this.selection.ids)[0];
                if (type === 'offroad') UI.openOffroadModal(id);
                if (type === 'settlements') UI.openSettlementModal(id);
                if (type === 'history') UI.openCollectionModal(id); // Using existing or new modal
                if (type === 'projections') UI.openProjectionModal(id);
            },

            // --- PAGE RENDERING ---
            handleProjectionSubmit(e) {
                e.preventDefault();
                UI.toggleLoader(true);
                (async () => {
                    const amountInput = document.getElementById('proj-amount');
                    const filesInput = document.getElementById('proj-files');

                    const amount = parseFloat(amountInput.value) || 0;
                    const files = filesInput.value;

                    const db = Store.get();
                    const today = new Date().toISOString().split('T')[0];

                    let tId = Auth.currentUser.territoryId;
                    if (!tId) {
                        const t = db.territories.find(t => t.name === Auth.currentUser.username || t.officer === Auth.currentUser.username);
                        if (t) tId = t.id;
                    }

                    // For the backend, we just send the update
                    await Store.update('projections', {
                        territory_id: tId,
                        date: today,
                        regular_amount: amount,
                        advance_amount: 0,
                        amount: amount,
                        file_count: files
                    });

                    UI.showSuccess('Projection Submitted!');
                    Router.navigate('officer-dashboard');
                    UI.toggleLoader(false);
                })();
            },

            handleCollectionSubmit(e) {
                e.preventDefault();
                UI.toggleLoader(true);
                (async () => {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const tId = this.getCurrentTerritoryId();

                    const regAmt = parseFloat(document.getElementById('coll-reg-amount').value) || 0;
                    const advAmt = parseFloat(document.getElementById('coll-adv-amount').value) || 0;
                    const totalAmt = regAmt + advAmt;

                    if (totalAmt <= 0) {
                        alert("Please enter a valid amount (Regular or Advance).");
                        UI.toggleLoader(false);
                        return;
                    }

                    const entry = {
                        territory_id: tId,
                        date: todayStr,
                        customer_code: document.getElementById('coll-code').value,
                        file_id: 'N/A',
                        customer_name: 'N/A',
                        receipt: document.getElementById('coll-receipt').value,
                        amount: totalAmt,
                        regular_amount: regAmt,
                        advance_amount: advAmt,
                        mode: document.getElementById('coll-mode').value,
                        is_lm_np: document.getElementById('coll-lmnp').checked,
                        timestamp: Date.now()
                    };

                    await Store.update('collections', entry);
                    UI.showSuccess('Collection Saved Successfully');
                    document.getElementById('collection-form').reset();
                    document.getElementById('coll-date').valueAsDate = new Date();
                    UI.toggleLoader(false);
                })();
            },

            deleteCollection(id, timestamp) {
                const now = Date.now();
                const diffHours = (now - timestamp) / (1000 * 60 * 60);
                if (diffHours > 24) { alert('Cannot delete entries older than 24 hours.'); return; }
                if (confirm('Are you sure you want to delete this entry?')) {
                    (async () => {
                        await Store.delete('collections', id);
                        this.renderOfficerDashboard();
                    })();
                }
            },


            // --- OFFICER EXTRAS ---
            getCurrentTerritoryId() {
                const db = Store.get();
                let linkedTId = Auth.currentUser.territoryId;
                if (!linkedTId) {
                    const t = db.territories.find(t => t.name === Auth.currentUser.username || t.officer === Auth.currentUser.username);
                    if (t) linkedTId = t.id;
                }
                return linkedTId;
            },
            renderOfficerSettlementsView() {
                const db = Store.get();
                const linkedTId = this.getCurrentTerritoryId();

                if (!linkedTId) {
                    document.getElementById('views-container').innerHTML = `<div class="p-8 text-center text-slate-500">Your account is not linked to any Territory Data. Please contact Admin.</div>`;
                    return;
                }

                const settlements = db.settlements.filter(s => s.territoryId === linkedTId).sort((a, b) => new Date(b.date) - new Date(a.date));

                document.getElementById('views-container').innerHTML = `
                    <div class="animate-entry max-w-5xl mx-auto">
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Settlements & Closures</h2>
                                <p class="text-sm text-slate-500">History of early settlements and closures for your territory</p>
                            </div>
                            <button onclick="UI.openSettlementModal()" class="px-4 py-2 bg-brand-600 text-white rounded-lg shadow-lg hover:bg-brand-700 transition flex items-center font-bold text-sm">
                                <i class="fa-solid fa-plus mr-2"></i> New Settlement
                            </button>
                        </div>

                        <div class="glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden border border-slate-200 dark:border-slate-700">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 uppercase font-bold">
                                        <tr>
                                            <th class="px-6 py-4">Date</th>
                                            <th class="px-6 py-4">Customer Code</th>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4 text-right">Amount</th>
                                            <th class="px-6 py-4">Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${settlements.map(s => {
                    let badgeClass = s.type === 'Early Settlement' ? 'bg-purple-100 text-purple-700' : (s.type === 'Credit Note' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700');
                    return `
                                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                                    <td class="px-6 py-4 font-mono text-xs">${s.date}</td>
                                                    <td class="px-6 py-4 font-bold text-slate-700 dark:text-slate-300">#${s.customerCode}</td>
                                                    <td class="px-6 py-4">
                                                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${badgeClass}">${s.type}</span>
                                                    </td>
                                                    <td class="px-6 py-4 text-right font-mono font-bold">৳${Number(s.amount || 0).toLocaleString()}</td>
                                                    <td class="px-6 py-4 text-xs italic text-slate-500 truncate max-w-xs">${s.remarks || '-'}</td>
                                                </tr>
                                            `;
                }).join('')}
                                        ${settlements.length === 0 ? '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">No settlement records found.</td></tr>' : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },
            renderOfficerVehicleAnalytics() {
                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry max-w-2xl mx-auto mt-10" >
                        <div class="text-center mb-10">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-brand-100 text-brand-600 mb-4 shadow-lg hover-lift">
                                <i class="fa-solid fa-magnifying-glass-chart text-3xl"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Vehicle Performance Analytics</h2>
                            <p class="text-slate-500">Search by Customer ID to view performance data</p>
                        </div>

                        <div class="glass-panel p-2 rounded-2xl shadow-xl flex items-center mb-10 border-2 border-brand-100 dark:border-brand-900/50 focus-within:border-brand-500 transition-colors">
                            <i class="fa-solid fa-search text-slate-400 ml-4 text-xl"></i>
                            <input type="text" 
                                placeholder="Enter Customer ID (e.g. C-1001)..." 
                                class="w-full p-4 bg-transparent border-none outline-none text-lg font-mono font-bold text-slate-700 dark:text-white placeholder-slate-400"
                                onkeyup="UI.searchVehiclePerf(this.value)">
                        </div>

                        <div id="vehicle-result" class="hidden animate-fade-in">
                            <!-- Results injected here -->
                        </div>
                    </div>
            `;
            },

            // --- HISTORY ---
            renderOfficerHistory() {
                const today = new Date();
                // Default to current month
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry max-w-5xl mx-auto" >
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Collection History</h2>
                                <p class="text-sm text-slate-500">Review and track your past collections</p>
                            </div>
                            
                            <form onsubmit="UI.updateOfficerHistory(event)" class="flex items-center bg-white dark:bg-dark-card p-1.5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                                <div class="flex items-center px-2">
                                    <i class="fa-regular fa-calendar text-slate-400 mr-2"></i>
                                    <input type="date" name="startDate" value="${startOfMonth}" class="bg-transparent border-none text-xs font-bold text-slate-700 dark:text-slate-300 focus:ring-0 w-28 outline-none">
                                </div>
                                <span class="text-slate-300">-</span>
                                <div class="flex items-center px-2">
                                    <input type="date" name="endDate" value="${endOfMonth}" class="bg-transparent border-none text-xs font-bold text-slate-700 dark:text-slate-300 focus:ring-0 w-28 outline-none">
                                </div>
                                <button type="submit" class="bg-brand-500 hover:bg-brand-600 text-white p-2 rounded-lg transition shadow-md hover-lift">
                                    <i class="fa-solid fa-filter"></i>
                                </button>
                            </form>
                        </div>

                        <!--Summary Cards-->
                        <div id="history-summary" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                            <!-- Injected by JS -->
                        </div>

                        <!--Table -->
            <div class="glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden border border-slate-200 dark:border-slate-700">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 uppercase font-bold">
                            <tr>
                                <th class="px-6 py-3">Date</th>
                                <th class="px-6 py-3">Receipt</th>
                                <th class="px-6 py-3">Customer</th>
                                <th class="px-6 py-3">Mode</th>
                                <th class="px-6 py-3 text-right text-slate-400">Regular</th>
                                <th class="px-6 py-3 text-right text-brand-500">Advance</th>
                                <th class="px-6 py-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
                    </div>
            `;

                // Trigger initial load
                this.updateOfficerHistory(null, startOfMonth, endOfMonth);
            },

            updateOfficerHistory(e, startOverride, endOverride) {
                if (e) e.preventDefault();

                let start, end;
                if (e) {
                    const formData = new FormData(e.target);
                    start = formData.get('startDate');
                    end = formData.get('endDate');
                } else {
                    start = startOverride;
                    end = endOverride;
                }

                const db = Store.get();
                const linkedTId = this.getCurrentTerritoryId();


                const filtered = db.collections.filter(c =>
                    c.territoryId === linkedTId &&
                    c.date >= start &&
                    c.date <= end
                ).sort((a, b) => new Date(b.date) - new Date(a.date));

                // Calc Totals
                const totalAmt = filtered.reduce((s, c) => s + parseFloat(c.amount), 0);
                const count = filtered.length;
                const bankAmt = filtered.filter(c => c.mode === 'Bank Transfer').reduce((s, c) => s + parseFloat(c.amount), 0);

                // Update Summary
                document.getElementById('history-summary').innerHTML = `
            <div class="p-5 rounded-2xl bg-gradient-to-br from-brand-500 to-emerald-600 text-white shadow-lg relative overflow-hidden group" >
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-sack-dollar text-6xl"></i>
                        </div>
                        <p class="text-xs font-bold opacity-80 uppercase tracking-wider mb-1">Total Collected</p>
                        <p class="text-3xl font-bold">${totalAmt.toLocaleString()}</p>
                        <p class="text-xs opacity-70 mt-1">${start} to ${end}</p>
                    </div>
                    <div class="p-5 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <i class="fa-solid fa-receipt text-6xl text-slate-400"></i>
                        </div>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Transactions</p>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white">${count}</p>
                    </div>
                     <div class="p-5 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm hidden md:block relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <i class="fa-solid fa-building-columns text-6xl text-blue-500"></i>
                        </div>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Via Bank</p>
                        <p class="text-3xl font-bold text-blue-600">${bankAmt.toLocaleString()}</p>
                    </div>
        `;

                // Update Table
                const tbody = document.getElementById('history-table-body');
                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr > <td colspan="7" class="px-6 py-12 text-center text-slate-400 italic">No collections found for this period.</td></tr > `;
                } else {
                    tbody.innerHTML = filtered.map(c => {
                        const reg = c.regularAmount || (c.advanceAmount ? 0 : c.amount); // Fallback for old data
                        const adv = c.advanceAmount || 0;
                        return `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition" >
                            <td class="px-6 py-3 font-mono text-slate-600 dark:text-slate-400 text-xs">${c.date}</td>
                            <td class="px-6 py-3 font-medium text-slate-800 dark:text-white">#${c.receipt}</td>
                            <td class="px-6 py-3 font-bold text-brand-600">${c.customerCode || 'N/A'}</td>
                            <td class="px-6 py-3">
                                <span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-slate-100 dark:bg-slate-700 text-slate-500 border border-slate-200 dark:border-slate-600">${c.mode}</span>
                            </td>
                            <td class="px-6 py-3 text-right font-mono text-slate-500 text-xs">${parseFloat(reg).toLocaleString()}</td>
                            <td class="px-6 py-3 text-right font-mono text-brand-500 text-xs">${parseFloat(adv).toLocaleString()}</td>
                            <td class="px-6 py-3 text-right font-mono font-bold text-slate-800 dark:text-white">${parseFloat(c.amount).toLocaleString()}</td>
                        </tr >
            `}).join('');
                }
            },

            // --- EXPORTS & MODALS ---
            exportCSV() {
                const db = Store.get();
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Date,Territory,CustomerCode,Receipt,Regular,Advance,TotalAmount,Mode,Type\n";
                db.collections.forEach(c => {
                    const tName = db.territories.find(t => t.id === c.territoryId)?.name || 'Unknown';
                    const reg = c.regularAmount || (c.advanceAmount ? 0 : c.amount); // Fallback for old data
                    const adv = c.advanceAmount || 0;

                    const row = `${c.date}, "${tName}", "${c.customerCode || 'N/A'}", "${c.receipt}", ${reg},${adv},${c.amount},${c.mode},${c.isLmNp ? 'LM NP' : 'Regular'} `;
                    csvContent += row + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "recovery_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            openRawExportModal() {
                const today = new Date().toISOString().split('T')[0];
                const firstDay = new Date().toISOString().slice(0, 7) + '-01';

                const html = `
            <div class="text-left" >
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center mr-3">
                                <i class="fa-solid fa-file-csv text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Export Raw Data</h3>
                                <p class="text-xs text-slate-500">Select date range for customer-wise collection report</p>
                            </div>
                        </div>
                        
                        <form onsubmit="UI.processRawExport(event)" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                                    <input type="date" name="startDate" value="${firstDay}" class="w-full p-3 rounded-lg border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-brand-500 outline-none transition" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label>
                                    <input type="date" name="endDate" value="${today}" class="w-full p-3 rounded-lg border dark:bg-slate-800 dark:border-slate-600 focus:ring-2 focus:ring-brand-500 outline-none transition" required>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-xs text-blue-700 dark:text-blue-300 flex items-start">
                                <i class="fa-solid fa-circle-info mt-0.5 mr-2"></i>
                                <p>This will download a CSV file containing all individual collection entries, including Receipt No, Customer Code, Mode, Regular, Advance, and Total Amount.</p>
                            </div>

                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" onclick="document.getElementById('generic-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:text-slate-700 font-medium transition">Cancel</button>
                                <button type="submit" class="px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-bold shadow-lg transition transform active:scale-95">
                                    Download CSV
                                </button>
                            </div>
                        </form>
                    </div>
            `;
                this.showModal(html);
            },

            processRawExport(e) {
                e.preventDefault();
                UI.toggleLoader(true);
                setTimeout(() => {
                    const formData = new FormData(e.target);
                    const startDate = formData.get('startDate');
                    const endDate = formData.get('endDate');

                    const db = Store.get();
                    const filtered = db.collections.filter(c => c.date >= startDate && c.date <= endDate);

                    if (filtered.length === 0) {
                        alert('No data found for the selected period.');
                        UI.toggleLoader(false);
                        return;
                    }

                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Date,Territory,Officer,CustomerCode,ReceiptNo,Amount,PaymentMode,Type,Timestamp\n";

                    filtered.forEach(c => {
                        const territory = db.territories.find(t => t.id === c.territoryId);
                        const tName = territory ? territory.name : 'Unknown';
                        const officer = territory ? territory.officer : 'Unknown';
                        const reg = c.regularAmount || (c.advanceAmount ? 0 : c.amount);
                        const adv = c.advanceAmount || 0;

                        const row = [
                            c.date,
                            `"${tName}"`,
                            `"${officer}"`,
                            `"${c.customerCode || ''}"`,
                            `"${c.receipt}"`,
                            c.amount,
                            c.mode,
                            c.isLmNp ? 'LM NP' : 'Regular',
                            new Date(c.timestamp).toLocaleString()
                        ].join(",");
                        csvContent += row + "\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `ACI_Recovery_Raw_${startDate}_to_${endDate}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    document.getElementById('generic-modal').classList.add('hidden');
                    UI.toggleLoader(false);
                }, 1000);
            },

            showModal(content) {
                const modal = document.getElementById('generic-modal');
                const box = document.getElementById('modal-content');
                box.innerHTML = content;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    box.classList.remove('scale-95', 'opacity-0');
                    box.classList.add('scale-100', 'opacity-100');
                }, 10);
            },

            // --- HELPER METHODS ---
            createKPICard(title, value, icon, color) {
                const colors = { blue: 'bg-blue-100 text-blue-600', green: 'bg-emerald-100 text-emerald-600', purple: 'bg-indigo-100 text-indigo-600', orange: 'bg-orange-100 text-orange-600', red: 'bg-rose-100 text-rose-600', yellow: 'bg-yellow-100 text-yellow-600' };
                return `<div class="glass-panel p-6 rounded-xl shadow-sm dark:bg-dark-card hover-lift" ><div class="flex justify-between mb-4"><h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase">${title}</h3><div class="w-10 h-10 rounded-full ${colors[color]} flex items-center justify-center"><i class="fa-solid ${icon}"></i></div></div><div class="text-2xl font-bold dark:text-white">${value}</div></div> `;
            },

            getDailyTrendData(tId) {
                const db = Store.get();
                const today = new Date();
                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    labels.push(dateStr.slice(5));
                    const sum = db.collections.filter(c => c.territoryId === tId && c.date === dateStr).reduce((acc, curr) => acc + parseFloat(curr.amount), 0);
                    data.push(sum);
                }
                return { labels, data };
            },

            calcRowTotal(input) {
                const tr = input.closest('tr');
                const reg = parseFloat(tr.querySelector('input[name="projReg"]').value) || 0;
                const adv = parseFloat(tr.querySelector('input[name="projAdv"]').value) || 0;
                tr.querySelector('input[name="totalProj"]').value = reg + adv;
            },

            addEmptyDataRow() {
                const tbody = document.querySelector('#data-entry-table tbody');
                const rowCount = tbody.children.length + 1;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition";
                tr.innerHTML = `
            <td class="p-2 text-center text-slate-400 text-xs" > ${rowCount}</td>
                    <td class="p-1"><select name="part" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center"><option value="A">A</option><option value="B">B</option></select></td>
                    <td class="p-1"><input type="text" name="name" placeholder="New Territory" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-medium"></td>
                    <td class="p-1"><input type="number" name="targetFiles" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                    <td class="p-1"><input type="number" name="projFiles" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                    <td class="p-1"><input type="number" name="targetAmount" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-blue-600"></td>
                    <td class="p-1"><input type="number" name="projReg" oninput="UI.calcRowTotal(this)" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                    <td class="p-1"><input type="number" name="projAdv" oninput="UI.calcRowTotal(this)" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                    <td class="p-1"><input type="number" name="totalProj" readonly class="w-full p-2 bg-slate-50 dark:bg-slate-800 border-none text-right font-mono font-bold text-slate-500 cursor-default"></td>
                    <td class="p-1"><input type="number" name="lmNpTargetAmount" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-600"></td>
                    <td class="p-1"><input type="number" name="lmNpTargetFiles" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                    
                    <td class="p-1 border-l border-slate-100 dark:border-slate-700"><input type="number" name="totalOd" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-brand-600 dark:text-brand-400"></td>
                    <td class="p-1"><input type="number" name="odGrowthSply" step="0.01" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                    <td class="p-1"><input type="number" name="perFileOd" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                    <td class="p-1"><input type="number" name="sixPlusOdFiles" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>
                    <td class="p-1"><input type="number" name="sixPlusOdGrowthSplm" step="0.01" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-center font-mono"></td>

                    <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
        `;
                tbody.appendChild(tr);
            },

            addUserRow() {
                const tbody = document.querySelector('#user-mgmt-table tbody');
                const rowCount = tbody.children.length + 1;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition";
                tr.innerHTML = `
            <td class="p-2 text-center text-slate-400 text-xs" > ${rowCount}</td>
                    <td class="p-1"><input type="text" name="username" placeholder="New Territory" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-medium"></td>
                    <td class="p-1"><input type="text" name="officerName" placeholder="Officer Name" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                    <td class="p-1"><input type="text" name="password" placeholder="1234" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-mono text-slate-600 dark:text-slate-400"></td>
                    <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
        `;
                tbody.appendChild(tr);
            },

            saveBulkData() {
                const db = Store.get();
                const currentMonth = new Date().toISOString().slice(0, 7);
                const rows = document.querySelectorAll('#data-entry-table tbody tr');

                (async () => {
                    UI.toggleLoader(true);
                    const targets = [];
                    const territories = [];

                    rows.forEach(row => {
                        const id = row.getAttribute('data-id');
                        const getVal = (name) => row.querySelector(`[name="${name}"]`).value;
                        const getNum = (name) => parseFloat(getVal(name)) || 0;

                        const tId = id === 'new' ? 't' + Date.now().toString(36) + Math.random().toString(36).substr(2) : id;

                        territories.push({
                            id: tId,
                            name: getVal('name'),
                            part: getVal('part'),
                            officer: getVal('name')
                        });

                        targets.push({
                            territory_id: tId,
                            month: currentMonth,
                            files: getNum('targetFiles'),
                            proj_files: getNum('projFiles'),
                            amount: getNum('targetAmount'),
                            proj_reg: getNum('projReg'),
                            proj_adv: getNum('projAdv'),
                            lm_np_target_amount: getNum('lmNpTargetAmount'),
                            lm_np_target_files: getNum('lmNpTargetFiles'),
                            total_od: getNum('totalOd'),
                            od_growth_sply: getNum('odGrowthSply'),
                            per_file_od: getNum('per_file_od'),
                            six_plus_od_files: getNum('sixPlusOdFiles'),
                            six_plus_od_growth_splm: getNum('sixPlusOdGrowthSplm')
                        });
                    });

                    await fetch(`${Store.apiUrl}/sync-targets`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ territories, targets })
                    });

                    await Store.init(); // Refresh cache
                    UI.showSuccess('Monthly Targets & Setup Saved!');
                    UI.renderAdminDashboard();
                    UI.toggleLoader(false);
                })();
            },

            saveUsers() {
                (async () => {
                    UI.toggleLoader(true);
                    const users = [];
                    rows.forEach(row => {
                        const getVal = (name) => row.querySelector(`[name="${name}"]`).value;
                        const username = getVal('username');
                        if (username) {
                            users.push({
                                username: username,
                                officerName: getVal('officerName'),
                                password: getVal('password'),
                                role: 'officer',
                                territoryId: username // Usually mapped to territory name/id
                            });
                        }
                    });

                    await fetch(`${Store.apiUrl}/sync-users`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ users })
                    });

                    await Store.init();
                    UI.showSuccess('User Credentials Saved!');
                    UI.toggleLoader(false);
                })();
            },

            downloadTargetTemplate() {
                const db = Store.get();
                let csv = "Part,Territory Name,Total Files,Proj Files,Total EMI,Proj (Reg),Proj (Adv),LM NP Amt,LM NP Files,Total OD,OD Growth SPLY,Per File OD,6+ OD Files,6+ OD Growth SPLM\n";

                // Include all current territories from the Store
                db.territories.forEach(t => {
                    csv += `${t.part},${t.name},0,0,0,0,0,0,0,0,0,0,0,0\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = "target_setup_template.csv";
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
            },

            async handleCSVUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (!confirm('Importing new month data will clear all existing data and reset the system. Proceed?')) return;

                UI.toggleLoader(true);
                // Clear all data on server
                await fetch(`${Store.apiUrl}/sync-targets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ territories: [], targets: [] })
                });

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n').slice(1);
                    const territories = [];
                    const targets = [];
                    const currentMonth = new Date().toISOString().slice(0, 7);

                    rows.forEach((row, i) => {
                        if (!row.trim()) return;
                        const cols = row.split(',');
                        if (cols.length >= 14) {
                            const tId = cols[1].replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                            territories.push({ id: tId, name: cols[1], part: cols[0], officer: cols[1] });
                            targets.push({
                                territory_id: tId, month: currentMonth,
                                files: parseInt(cols[2]) || 0, proj_files: parseInt(cols[3]) || 0,
                                amount: parseFloat(cols[4]) || 0, proj_reg: parseFloat(cols[5]) || 0,
                                proj_adv: parseFloat(cols[6]) || 0, lm_np_target_amount: parseFloat(cols[7]) || 0,
                                lm_np_target_files: parseInt(cols[8]) || 0, total_od: parseFloat(cols[9]) || 0,
                                od_growth_sply: parseFloat(cols[10]) || 0, per_file_od: parseFloat(cols[11]) || 0,
                                six_plus_od_files: parseInt(cols[12]) || 0, six_plus_od_growth_splm: parseFloat(cols[13]) || 0
                            });
                        }
                    });

                    await fetch(`${Store.apiUrl}/sync-targets`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ territories, targets })
                    });

                    await Store.init();
                    UI.renderDataEntry();
                    UI.toggleLoader(false);
                    UI.showSuccess('Data Imported successfully');
                };
                reader.readAsText(file);
            },

            handleUserCSV(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n').slice(1);
                    const tbody = document.querySelector('#user-mgmt-table tbody');
                    tbody.innerHTML = '';
                    rows.forEach((row, i) => {
                        if (!row.trim()) return;
                        const cols = row.split(',');
                        if (cols.length >= 3) {
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition";
                            tr.innerHTML = `
                                <td class="p-2 text-center text-slate-400 text-xs">${i + 1}</td>
                                <td class="p-1"><input type="text" name="username" value="${(cols[0] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-medium"></td>
                                <td class="p-1"><input type="text" name="officerName" value="${(cols[1] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                <td class="p-1"><input type="text" name="password" value="${(cols[2] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-mono text-slate-600 dark:text-slate-400"></td>
                                <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
                            `;
                            tbody.appendChild(tr);
                        }
                    });
                };
                reader.readAsText(file);
            },

            downloadUserTemplate() {
                const csv = "Territory Name (Username),Officer Name,Employee ID (Password)\n" +
                    "Region 01,John Doe,EMP101";
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = "user_import_template.csv";
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
            },



            handleVehiclePerfCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const text = e.target.result;
                    const rows = text.split('\n').slice(1);
                    const tbody = document.querySelector('#vehicle-perf-table tbody');
                    tbody.innerHTML = '';

                    rows.forEach(row => {
                        const cols = row.split(',');
                        if (cols.length >= 6) {
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition";
                            tr.innerHTML = `
            <td class="p-1" ><input type="text" name="customerId" value="${(cols[0] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-mono font-bold"></td>
                                <td class="p-1"><input type="text" name="customerName" value="${(cols[1] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                <td class="p-1"><input type="text" name="model" value="${(cols[2] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                <td class="p-1"><input type="number" name="km1" value="${(cols[3] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                                <td class="p-1"><input type="number" name="km2" value="${(cols[4] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                                <td class="p-1"><input type="number" name="earning" value="${(cols[5] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono font-bold text-brand-600"></td>
                                <td class="p-1"><input type="number" name="overdueNo" value="${(cols[6] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-500"></td>
                                <td class="p-1"><input type="number" name="overdueAmt" value="${(cols[7] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-600 font-bold"></td>
                                <td class="p-1"><input type="text" name="extra1" value="${(cols[8] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                <td class="p-1"><input type="text" name="extra2" value="${(cols[9] || '').trim()}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
        `;
                            tbody.appendChild(tr);
                        }
                    });
                };
                reader.readAsText(file);
            },

            renderAdminVehiclePerf() {
                const db = Store.get();
                const data = db.vehicle_performance || [];
                // Migration: Ensure IDs
                let dirty = false;
                data.forEach(d => { if (!d.id) { d.id = Math.random().toString(36).substring(2); dirty = true; } });
                if (dirty) Store.save(db);

                // Extract all IDs for Select All
                const allIds = data.map(d => d.id);

                document.getElementById('views-container').innerHTML = `
            <div class="animate-entry flex flex-col h-[calc(100vh-140px)]" >
                        <div class="mb-6 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Vehicle Performance Data</h2>
                                <p class="text-sm text-slate-500">Upload running data, earning estimates, and overdue info</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="UI.downloadVehiclePerfTemplate()" class="flex items-center px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition text-sm font-medium hover-lift">
                                    <i class="fa-solid fa-download mr-2 text-slate-500"></i> Template
                                </button>
                                <label class="flex items-center px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition text-sm font-medium cursor-pointer hover-lift">
                                    <i class="fa-solid fa-file-csv mr-2 text-brand-600"></i> Import CSV
                                    <input type="file" class="hidden" accept=".csv" onchange="UI.handleVehiclePerfCSV(event)">
                                </label>
                                <button onclick="UI.saveVehiclePerf()" class="px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 shadow-lg font-bold hover-lift">
                                    <i class="fa-solid fa-save mr-2"></i> Save Data
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 glass-panel rounded-xl shadow-lg dark:bg-dark-card overflow-hidden flex flex-col border border-slate-200 dark:border-slate-700">
                             <div class="overflow-auto flex-1">
                                <table class="w-full text-sm text-left border-collapse" id="vehicle-perf-table">
                                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 uppercase sticky top-0 z-10 font-bold text-xs">
                                        <tr>
                                            <th class="p-3 border-b dark:border-slate-700 w-10 text-center">
                                                <input type="checkbox" id="select-all-vehicle_performance" onchange="UI.selectAll('vehicle_performance', ['${allIds.join("','")}'])" class="rounded border-slate-300 cursor-pointer">
                                            </th>
                                            <th class="p-3 border-b dark:border-slate-700 w-24">Cust. ID</th>
                                            <th class="p-3 border-b dark:border-slate-700 w-32">Name</th>
                                            <th class="p-3 border-b dark:border-slate-700 w-24">Model</th>
                                            <th class="p-3 border-b dark:border-slate-700 text-right w-20">M1 KM</th>
                                            <th class="p-3 border-b dark:border-slate-700 text-right w-20">M2 KM</th>
                                            <th class="p-3 border-b dark:border-slate-700 text-right text-brand-600 w-24">Earning</th>
                                            <th class="p-3 border-b dark:border-slate-700 text-right text-rose-500 w-20">OD No</th>
                                            <th class="p-3 border-b dark:border-slate-700 text-right text-rose-600 w-24">OD Amt</th>
                                            <th class="p-3 border-b dark:border-slate-700 w-24">Info 1</th>
                                            <th class="p-3 border-b dark:border-slate-700 w-24">Info 2</th>
                                            <th class="p-3 border-b dark:border-slate-700 text-center w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        ${data.length > 0 ? data.map(row => `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition" data-row-id="${row.id}">
                                                <td class="p-3 text-center">
                                                    <input type="checkbox" onchange="UI.toggleSelect('vehicle_performance', '${row.id}')" data-select-type="vehicle_performance" data-id="${row.id}" class="rounded border-slate-300 cursor-pointer">
                                                </td>
                                                <td class="p-1"><input type="text" name="customerId" value="${row.customerId || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-mono font-bold"></td>
                                                <td class="p-1"><input type="text" name="customerName" value="${row.customerName || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                                <td class="p-1"><input type="text" name="model" value="${row.model || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                                <td class="p-1"><input type="number" name="km1" value="${row.km1 || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                                                <td class="p-1"><input type="number" name="km2" value="${row.km2 || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                                                <td class="p-1"><input type="number" name="earning" value="${row.earning || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono font-bold text-brand-600"></td>
                                                <td class="p-1"><input type="number" name="overdueNo" value="${row.overdueNo || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-500"></td>
                                                <td class="p-1"><input type="number" name="overdueAmt" value="${row.overdueAmt || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-600 font-bold"></td>
                                                <td class="p-1"><input type="text" name="extra1" value="${row.extra1 || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                                <td class="p-1"><input type="text" name="extra2" value="${row.extra2 || ''}" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                                                <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
                                            </tr>
                                        `).join('') : `
                                            <tr><td colspan="12" class="p-8 text-center text-slate-400 italic">No data. Add rows or import CSV.</td></tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                            <div class="p-3 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 flex justify-between">
                                <button onclick="UI.addVehiclePerfRow()" class="text-brand-600 hover:text-brand-700 font-bold">+ Add Row</button>
                            </div>
                        </div>
                    </div>
            `;
            },

            addVehiclePerfRow() {
                const tbody = document.querySelector('#vehicle-perf-table tbody');
                if (tbody.children.length === 1 && tbody.children[0].innerText.includes('No data')) tbody.innerHTML = '';

                const id = 'new_' + Date.now();
                const tr = document.createElement('tr');
                tr.setAttribute('data-row-id', id);
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition";
                tr.innerHTML = `
            <td class="p-3 text-center" >
                         <!--New rows not selectable until saved-->
            <i class="fa-solid fa-asterisk text-slate-300 text-xs"></i>
                    </td>
                    <td class="p-1"><input type="text" name="customerId" placeholder="C-XXXX" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none font-mono font-bold"></td>
                    <td class="p-1"><input type="text" name="customerName" placeholder="Name" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                    <td class="p-1"><input type="text" name="model" placeholder="Model" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                    <td class="p-1"><input type="number" name="km1" placeholder="0" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                    <td class="p-1"><input type="number" name="km2" placeholder="0" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono"></td>
                    <td class="p-1"><input type="number" name="earning" placeholder="0" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono font-bold text-brand-600"></td>
                    <td class="p-1"><input type="number" name="overdueNo" placeholder="0" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-500"></td>
                    <td class="p-1"><input type="number" name="overdueAmt" placeholder="0" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none text-right font-mono text-rose-600 font-bold"></td>
                    <td class="p-1"><input type="text" name="extra1" placeholder="Info" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                    <td class="p-1"><input type="text" name="extra2" placeholder="Info" class="w-full p-2 bg-transparent border border-transparent hover:border-slate-300 rounded outline-none"></td>
                    <td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
        `;
                tbody.appendChild(tr);
                tbody.lastElementChild.scrollIntoView({ behavior: 'smooth' });
            },

            // NEW TEMPLATE DOWNLOAD FUNCTION
            downloadVehiclePerfTemplate() {
                const csvContent = "CustomerID,CustomerName,VehicleModel,KMRunMonth1,KMRunMonth2,EstimatedEarning,OverdueNo,OverdueAmount,ExtraInfo1,ExtraInfo2\n" +
                    "C-1001,John Doe,Yamaha FZS V3,1200,1500,25000,1,5500,Note1,Note2";

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `vehicle_performance_template.csv`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
            },

            async saveVehiclePerf() {
                UI.toggleLoader(true);
                const rows = document.querySelectorAll('#vehicle-perf-table tbody tr');
                const data = [];
                rows.forEach(row => {
                    const getVal = (name) => row.querySelector(`input[name = "${name}"]`)?.value || '';
                    const cid = getVal('customerId');

                    if (cid) {
                        data.push({
                            customerId: cid,
                            customerName: getVal('customerName'),
                            model: getVal('model'),
                            km1: parseFloat(getVal('km1')) || 0,
                            km2: parseFloat(getVal('km2')) || 0,
                            earning: parseFloat(getVal('earning')) || 0,
                            overdueNo: parseInt(getVal('overdueNo')) || 0,
                            overdueAmt: parseFloat(getVal('overdueAmt')) || 0,
                            extra1: getVal('extra1'),
                            extra2: getVal('extra2')
                        });
                    }
                });

                await fetch(`${Store.apiUrl}/sync-vehicle-perf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data })
                });

                await Store.init();
                UI.showSuccess('Vehicle Performance Data Saved!');
                UI.renderAdminVehiclePerf();
                UI.toggleLoader(false);
            },



            searchVehiclePerf(query) {
                if (!query) return;
                UI.toggleLoader(true);
                const container = document.getElementById('vehicle-result');
                if (container) container.classList.add('hidden');

                setTimeout(() => {
                    const db = Store.get();
                    // Basic exact match or includes
                    query = query.toUpperCase();
                    const vehicle = (db.vehicle_performance || []).find(v => v.customerId.toUpperCase() === query || v.customerId.toUpperCase().includes(query));

                    if (!container) return;

                    if (vehicle) {
                        const totalKm = (parseFloat(vehicle.km1) || 0) + (parseFloat(vehicle.km2) || 0);
                        container.innerHTML = `
            <div class="glass-panel p-0 rounded-3xl shadow-2xl dark:bg-dark-card overflow-hidden border border-brand-100 dark:border-brand-900/30">
                                <div class="bg-gradient-to-r from-brand-600 to-emerald-500 p-6 text-white relative overflow-hidden">
                                    <div class="absolute -right-6 -bottom-6 opacity-20 transform rotate-12">
                                        <i class="fa-solid fa-truck-fast text-9xl"></i>
                                    </div>
                                    <div class="relative z-10">
                                        <div class="inline-block px-3 py-1 rounded-full bg-white/20 text-xs font-bold mb-3 border border-white/30 backdrop-blur-sm">${vehicle.customerId}</div>
                                        <h3 class="text-2xl font-bold mb-1">${vehicle.customerName || 'Unknown'}</h3>
                                        <p class="opacity-90 font-medium flex items-center"><i class="fa-solid fa-car-side mr-2"></i> ${vehicle.model || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div class="p-6">
                                    <div class="flex items-center justify-between mb-8 p-5 bg-amber-50 dark:bg-amber-900/10 rounded-2xl border border-amber-100 dark:border-amber-800/30">
                                        <div>
                                            <p class="text-xs font-bold text-amber-600 uppercase tracking-wider mb-1">Estimated Earning</p>
                                            <h4 class="text-3xl font-black text-amber-600">à§³ ${parseFloat(vehicle.earning || 0).toLocaleString()}</h4>
                                        </div>
                                        <div class="w-12 h-12 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center text-xl">
                                            <i class="fa-solid fa-money-bill-trend-up"></i>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4 mb-2">
                                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl text-center border border-slate-100 dark:border-slate-700">
                                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Last 2 Months Run</p>
                                            <p class="text-xl font-bold text-slate-800 dark:text-white">${totalKm.toLocaleString()} <span class="text-xs text-slate-500">KM</span></p>
                                        </div>
                                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl text-center border border-slate-100 dark:border-slate-700">
                                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Avg. Monthly</p>
                                            <p class="text-xl font-bold text-slate-800 dark:text-white">${Math.round(totalKm / 2).toLocaleString()} <span class="text-xs text-slate-500">KM</span></p>
                                        </div>
                                    </div>

                                    <div class="flex gap-1 mt-4">
                                        <div class="h-2 rounded-l-full bg-blue-400" style="width: ${(vehicle.km1 / totalKm) * 100}%" title="Month 1: ${vehicle.km1}"></div>
                                        <div class="h-2 rounded-r-full bg-blue-600" style="width: ${(vehicle.km2 / totalKm) * 100}%" title="Month 2: ${vehicle.km2}"></div>
                                    </div>
                                    <div class="flex justify-between text-[10px] text-slate-400 mt-1 font-medium">
                                        <span>Month 1: ${vehicle.km1} km</span>
                                        <span>Month 2: ${vehicle.km2} km</span>
                                    </div>
                                </div>
                            </div>
            `;
                    } else {
                        container.innerHTML = `
            <div class="glass-panel p-8 text-center bg-red-50 dark:bg-red-900/10 rounded-2xl border border-red-100 dark:border-red-900/30">
                                <div class="text-red-400 text-4xl mb-3"><i class="fa-regular fa-circle-xmark"></i></div>
                                <h3 class="text-lg font-bold text-red-600 mb-1">No Data Found</h3>
                                <p class="text-sm text-red-500 opacity-80">Could not find vehicle data for ID: <b>${query}</b></p>
                            </div>
            `;
                    }

                    container.classList.remove('hidden');
                    UI.toggleLoader(false);
                }, 500);
            },

            // --- MODAL HANDLERS (NEW) ---
            renderModal(title, content) {
                let m = document.getElementById('generic-modal');
                // Ensure modal wrapper exists (it should from static HTML)
                if (!m) {
                    console.error('Generic modal container not found');
                    return;
                }

                const modalContent = document.getElementById('modal-content');
                if (!modalContent) {
                    console.error('Modal content container not found');
                    return;
                }

                // Inject full structure including title and body into modal-content
                modalContent.innerHTML = `
                    <div class="flex justify-between items-center p-6 border-b border-slate-100 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="modal-title">${title}</h3>
                        <button onclick="UI.closeModal('generic-modal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    <div id="modal-body" class="p-6">${content}</div>
                `;

                m.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            },

            openSettlementModal(id = null) {
                const db = Store.get();
                const item = id ? db.settlements.find(s => s.id === id) : {};
                const isOfficer = Auth.currentUser.role === 'officer';
                const currentTId = isOfficer ? this.getCurrentTerritoryId() : (item.territoryId || '');
                const territories = db.territories.map(t => `<option value="${t.id}" ${item.territoryId === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

                const html = `
                    <form onsubmit="UI.saveSettlement(event)" class="space-y-4">
                        <input type="hidden" name="id" value="${id || ''}">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                <input type="date" name="date" value="${item.date || new Date().toISOString().split('T')[0]}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                            </div>
                            ${isOfficer ? `
                            <div class="flex flex-col justify-end pb-1">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Territory</span>
                                <span class="text-sm font-bold text-brand-600">${db.territories.find(t => t.id === currentTId)?.name || 'N/A'}</span>
                                <input type="hidden" name="territoryId" value="${currentTId}">
                            </div>` : `
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Territory</label>
                                <select name="territoryId" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                                    <option value="">Select Territory</option>
                                    ${territories}
                                </select>
                            </div>`}
                        </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer Code</label>
                        <input type="text" name="customerCode" value="${item.customerCode || ''}" required placeholder="C-XXXX" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 font-mono font-bold">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                            <select name="type" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                                <option value="Regular Close" ${item.type === 'Regular Close' ? 'selected' : ''}>Regular Close</option>
                                <option value="Early Settlement" ${item.type === 'Early Settlement' ? 'selected' : ''}>Early Settlement</option>
                                <option value="Credit Note" ${item.type === 'Credit Note' ? 'selected' : ''}>Credit Note</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount</label>
                            <input type="number" name="amount" value="${item.amount || ''}" placeholder="0" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 font-mono font-bold">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Remarks</label>
                        <textarea name="remarks" rows="2" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">${item.remarks || ''}</textarea>
                    </div>
                    <button type="submit" class="w-full py-3 bg-brand-600 text-white font-bold rounded-lg hover:bg-brand-700 shadow-lg hover-lift transition">
                        <i class="fa-solid fa-save mr-2"></i> Save Settlement
                    </button>
                </form>
        `;
                this.renderModal(id ? 'Edit Settlement' : 'Add New Settlement', html);
            },

            saveSettlement(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const db = Store.get();

                if (data.id) {
                    const idx = db.settlements.findIndex(s => s.id === data.id);
                    if (idx !== -1) db.settlements[idx] = { ...db.settlements[idx], ...data };
                } else {
                    data.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                    data.timestamp = Date.now();
                    db.settlements.push(data);
                }

                Store.save(db);
                UI.closeModal('generic-modal');

                if (Auth.currentUser.role === 'admin') {
                    UI.renderAdminSettlementsView();
                } else {
                    UI.renderOfficerSettlementsView();
                }

                UI.showSuccess('Settlement Saved!');
            },

            openCollectionModal(id = null) {
                const db = Store.get();
                const item = id ? db.collections.find(c => c.id === id) : {};
                const isOfficer = Auth.currentUser.role === 'officer';
                const currentTId = isOfficer ? this.getCurrentTerritoryId() : (item.territoryId || '');
                const territories = db.territories.map(t => `<option value="${t.id}" ${item.territoryId === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

                const html = `
                    <form onsubmit="UI.saveManualCollection(event)" class="space-y-4">
                        <input type="hidden" name="id" value="${id || ''}">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                <input type="date" name="date" value="${item.date || new Date().toISOString().split('T')[0]}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                            </div>
                            ${isOfficer ? `
                            <div class="flex flex-col justify-end pb-1 text-right">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Territory</span>
                                <span class="text-sm font-bold text-brand-600">${db.territories.find(t => t.id === currentTId)?.name || 'N/A'}</span>
                                <input type="hidden" name="territoryId" value="${currentTId}">
                            </div>` : `
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Territory</label>
                                <select name="territoryId" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                                    <option value="">Select Territory</option>
                                    ${territories}
                                </select>
                            </div>`}
                        </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Money Receipt No</label>
                            <input type="text" name="receipt" value="${item.receipt || ''}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 font-mono font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer ID</label>
                            <input type="text" name="customerCode" value="${item.customerCode || ''}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 font-mono font-bold">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Regular</label>
                            <input type="number" name="regularAmount" value="${item.regularAmount || 0}" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 text-right font-mono">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Advance</label>
                            <input type="number" name="advanceAmount" value="${item.advanceAmount || 0}" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 text-right font-mono">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Payment Mode</label>
                        <select name="mode" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                            <option value="Cash" ${item.mode === 'Cash' ? 'selected' : ''}>Cash</option>
                            <option value="Bank Transfer" ${item.mode === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                            <option value="Cheque" ${item.mode === 'Cheque' ? 'selected' : ''}>Cheque</option>
                            <option value="Bkash/Nagad" ${item.mode === 'Bkash/Nagad' ? 'selected' : ''}>Bkash/Nagad</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full py-3 bg-brand-600 text-white font-bold rounded-lg hover:bg-brand-700 shadow-lg hover-lift transition">
                        <i class="fa-solid fa-save mr-2"></i> Save Collection
                    </button>
                </form>
        `;
                this.renderModal(id ? 'Edit Collection' : 'Add Manual Collection', html);
            },

            saveManualCollection(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const reg = parseFloat(formData.get('regularAmount')) || 0;
                const adv = parseFloat(formData.get('advanceAmount')) || 0;

                const data = {
                    id: formData.get('id'),
                    date: formData.get('date'),
                    territoryId: formData.get('territoryId'),
                    receipt: formData.get('receipt'),
                    customerCode: formData.get('customerCode'),
                    regularAmount: reg,
                    advanceAmount: adv,
                    amount: reg + adv,
                    mode: formData.get('mode'),
                    timestamp: Date.now()
                };

                const db = Store.get();
                if (data.id) {
                    const idx = db.collections.findIndex(c => c.id === data.id);
                    if (idx !== -1) db.collections[idx] = { ...db.collections[idx], ...data };
                } else {
                    data.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                    db.collections.push(data);
                }

                Store.save(db);
                UI.closeModal('generic-modal');
                if (document.getElementById('admin-history-table-body')) UI.updateAdminHistory(null, data.date.substring(0, 8) + '01', data.date.substring(0, 8) + '31');
                else UI.renderAdminHistory();

                UI.showSuccess('Collection Saved!');
            },

            openOffroadModal(id = null) {
                const db = Store.get();
                const item = id ? db.offroad_vehicles.find(v => v.id === id) : {};
                const isOfficer = Auth.currentUser.role === 'officer';
                const currentTId = isOfficer ? this.getCurrentTerritoryId() : (item.territoryId || '');
                const territories = db.territories.map(t => `<option value="${t.id}" ${item.territoryId === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

                const html = `
                    <form onsubmit="UI.saveOffroad(event)" class="space-y-4">
                        <input type="hidden" name="id" value="${id || ''}">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">In Date</label>
                                <input type="date" name="inDate" value="${item.inDate || new Date().toISOString().split('T')[0]}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer Code</label>
                                <input type="text" name="customerCode" value="${item.customerCode || ''}" required placeholder="C-XXXX" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 font-mono font-bold">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Reason</label>
                                <select name="reason" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                                    <option value="">Select Reason</option>
                                    <option value="Accident" ${item.reason === 'Accident' ? 'selected' : ''}>Accident</option>
                                    <option value="Capture" ${item.reason === 'Capture' ? 'selected' : ''}>Capture</option>
                                    <option value="Thana/Police station" ${item.reason === 'Thana/Police station' ? 'selected' : ''}>Thana/Police station</option>
                                    <option value="Lost or untraceable" ${item.reason === 'Lost or untraceable' ? 'selected' : ''}>Lost or untraceable</option>
                                </select>
                            </div>
                        </div>

                        ${isOfficer ? `<input type="hidden" name="territoryId" value="${currentTId}">` : `
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Territory</label>
                            <select name="territoryId" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                                <option value="">Select Territory</option>
                                ${territories}
                            </select>
                        </div>`}
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Vehicle currently in location</label>
                            <input type="text" name="location" value="${item.location || ''}" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Remarks</label>
                            <textarea name="remarks" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 h-20">${item.remarks || ''}</textarea>
                        </div>

                        <button type="submit" class="w-full py-4 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition transform active:scale-95">
                            <i class="fa-solid fa-save mr-2"></i> Submit Offroad Report
                        </button>
                    </form>
                `;
                this.renderModal(id ? 'Update Offroad record' : 'Report Offroad Vehicle', html);
            },

            saveOffroad(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const db = Store.get();

                if (data.id) {
                    const idx = db.offroad_vehicles.findIndex(v => v.id === data.id);
                    if (idx !== -1) {
                        if (data.status === 'Solved' && db.offroad_vehicles[idx].status !== 'Solved') {
                            data.solveDate = new Date().toISOString().split('T')[0];
                        }
                        db.offroad_vehicles[idx] = { ...db.offroad_vehicles[idx], ...data };
                    }
                } else {
                    data.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                    data.status = 'Active';
                    db.offroad_vehicles.push(data);
                }

                Store.save(db);
                UI.closeModal('generic-modal');

                if (Auth.currentUser.role === 'admin') {
                    UI.renderAdminOffroadView();
                } else {
                    UI.renderOfficerOffroadTracker();
                }
                UI.showSuccess('Offroad Case Saved!');
            },

            resolveOffroad(id) {
                const db = Store.get();
                const idx = db.offroad_vehicles.findIndex(v => v.id === id);
                if (idx !== -1) {
                    if (confirm('Mark this case as Solved?')) {
                        db.offroad_vehicles[idx].status = 'Solved';
                        db.offroad_vehicles[idx].solveDate = new Date().toISOString().split('T')[0];
                        Store.save(db);
                        if (Auth.currentUser.role === 'admin') {
                            UI.renderAdminOffroadView();
                        } else {
                            UI.renderOfficerOffroadTracker();
                        }
                    }
                }
            },

            openProjectionModal(id = null) {
                const db = Store.get();
                const item = id ? db.projections.find(p => p.id === id) : {};
                const isOfficer = Auth.currentUser.role === 'officer';
                const currentTId = isOfficer ? this.getCurrentTerritoryId() : (item.territoryId || '');
                const territories = db.territories.map(t => `<option value="${t.id}" ${item.territoryId === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

                const html = `
                    <form onsubmit="UI.saveProjection(event)" class="space-y-4">
                        <input type="hidden" name="id" value="${id || ''}">
                        ${isOfficer ? `
                        <div class="mb-4 p-3 bg-brand-50 dark:bg-brand-900/10 rounded-lg border border-brand-100 dark:border-brand-900/20">
                            <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Managing Territory</span>
                            <span class="text-sm font-bold text-brand-600">${db.territories.find(t => t.id === currentTId)?.name || 'N/A'}</span>
                            <input type="hidden" name="territoryId" value="${currentTId}">
                        </div>` : `
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Territory</label>
                            <select name="territoryId" required ${id ? 'disabled' : ''} class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500">
                                <option value="">Select Territory</option>
                                ${territories}
                            </select>
                        </div>`}
                        ${isOfficer ? `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Target Amount (Total)</label>
                                <input type="number" name="amount" value="${item.amount || (item.regularAmount || 0) + (item.advanceAmount || 0) || ''}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 text-right font-mono font-bold">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">File Count Target</label>
                                <input type="number" name="fileCount" value="${item.fileCount || ''}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 text-center font-mono font-bold">
                            </div>
                        </div>` : `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Regular Target</label>
                                <input type="number" name="regularAmount" value="${item.regularAmount || 0}" required class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 text-right font-mono">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Advance Target</label>
                                <input type="number" name="advanceAmount" value="${item.advanceAmount || 0}" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 text-right font-mono">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">File Count Target</label>
                            <input type="number" name="fileCount" value="${item.fileCount || 0}" class="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 text-center font-mono">
                        </div>`}
                    <button type="submit" class="w-full py-3 bg-brand-600 text-white font-bold rounded-lg hover:bg-brand-700 shadow-lg hover-lift transition">
                        <i class="fa-solid fa-save mr-2"></i> Save Projection
                    </button>
                </form>
                 `;
                this.renderModal(id ? 'Edit Projection' : 'Add Projection', html);
            },

            saveProjection(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const isOfficer = Auth.currentUser.role === 'officer';

                let reg = parseFloat(formData.get('regularAmount')) || 0;
                let adv = parseFloat(formData.get('advanceAmount')) || 0;
                let total = reg + adv;

                if (isOfficer) {
                    total = parseFloat(formData.get('amount')) || 0;
                    reg = total;
                    adv = 0;
                }

                const data = {
                    id: formData.get('id'),
                    territoryId: formData.get('territoryId'), // Might be missing if disabled
                    regularAmount: reg,
                    advanceAmount: adv,
                    amount: total,
                    fileCount: formData.get('fileCount'),
                    date: new Date().toISOString().split('T')[0]
                };

                const db = Store.get();
                if (data.id) {
                    const idx = db.projections.findIndex(p => p.id === data.id);
                    if (idx !== -1) {
                        if (!data.territoryId) data.territoryId = db.projections[idx].territoryId;
                        db.projections[idx] = { ...db.projections[idx], ...data };
                    }
                } else {
                    const existing = db.projections.find(p => p.territoryId === data.territoryId && p.date === data.date);
                    if (existing) {
                        if (!confirm('Projection for this territory already exists today. Overwrite?')) return;
                        Object.assign(existing, data);
                    } else {
                        data.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                        db.projections.push(data);
                    }
                }

                Store.save(db);
                UI.closeModal('generic-modal');
                UI.renderAdminProjections();
                UI.showSuccess('Projection Saved!');
            },

            // --- HELPERS ---
            getOffroadIcon(reason) {
                if (!reason) return 'fa-triangle-exclamation';
                if (reason.includes('Thana') || reason.includes('Police')) return 'fa-shield-halved';
                if (reason === 'Capture' || reason === 'Captured') return 'fa-handcuffs';
                if (reason === 'Lost or untraceable') return 'fa-magnifying-glass-blur';
                return 'fa-triangle-exclamation';
            },
            getOffroadBadgeColor(reason) {
                if (!reason) return 'bg-red-100 text-red-600 border-red-200';
                if (reason.includes('Thana') || reason.includes('Police')) return 'bg-blue-100 text-blue-600 border border-blue-200';
                if (reason === 'Capture' || reason === 'Captured') return 'bg-orange-100 text-orange-600 border border-orange-200';
                if (reason === 'Lost or untraceable') return 'bg-slate-100 text-slate-600 border border-slate-200';
                return 'bg-red-100 text-red-600 border-red-200';
            },
            showModal(id) {
                const m = document.getElementById(id);
                if (m) {
                    m.classList.remove('hidden');
                    setTimeout(() => {
                        if (m.firstElementChild) {
                            m.firstElementChild.classList.remove('opacity-0', 'scale-95');
                            m.firstElementChild.classList.add('opacity-100', 'scale-100');
                        }
                    }, 10);
                }
            },
            closeModal(id) {
                const m = document.getElementById(id);
                if (m) {
                    if (m.firstElementChild) {
                        m.firstElementChild.classList.remove('opacity-100', 'scale-100');
                        m.firstElementChild.classList.add('opacity-0', 'scale-95');
                    }
                    setTimeout(() => m.classList.add('hidden'), 300);
                }
            },
            showSuccess(message) {
                const existing = document.getElementById('success-toast');
                if (existing) existing.remove();

                const toast = document.createElement('div');
                toast.id = 'success-toast';
                toast.className = 'fixed top-6 right-6 z-[100] flex items-center gap-3 bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl border-l-4 border-emerald-500 shadow-2xl rounded-xl px-6 py-4 pr-10 min-w-[320px] transform transition-all duration-500 translate-x-full opacity-0';
                toast.innerHTML = `
                    <div class="bg-emerald-100 text-emerald-600 rounded-full w-10 h-10 flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-check text-lg"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 dark:text-white text-sm">Success</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition">
                        <i class="fa-solid fa-xmark text-sm"></i>
                    </button>
                    <!-- Progress Bar -->
                    <div class="absolute bottom-0 left-0 h-1 bg-emerald-500/50 rounded-b-xl transition-all duration-[3000ms] ease-linear w-0" id="toast-progress"></div>
                `;

                document.body.appendChild(toast);

                // Entrance animation
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    document.getElementById('toast-progress').style.width = '100%';
                });

                // Auto remove
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        toast.classList.add('translate-x-full', 'opacity-0');
                        setTimeout(() => toast.remove(), 500);
                    }
                }, 3000);
            },
            toggleLoader(show) {
                const loader = document.getElementById('global-loader');
                if (loader) {
                    if (show) {
                        loader.classList.remove('hidden');
                        void loader.offsetWidth;
                        loader.classList.remove('opacity-0');
                    } else {
                        loader.classList.add('opacity-0');
                        setTimeout(() => loader.classList.add('hidden'), 300);
                    }
                }
            },

            async captureDashboard() {
                UI.toggleLoader(true);
                UI.showSuccess('Generating Formal Excel Report...');

                const dashboard = document.getElementById('views-container');
                if (!dashboard) {
                    UI.toggleLoader(false);
                    return;
                }

                // Helper: Robust text extraction by label
                const findValueByLabel = (label, root = dashboard) => {
                    const spans = Array.from(root.querySelectorAll('span, td, th'));
                    const target = spans.find(s => s.innerText.trim().toUpperCase() === label.toUpperCase());
                    if (!target) return 'N/A';

                    // Check next sibling for metric-style layout
                    if (target.nextElementSibling) return target.nextElementSibling.innerText.trim();

                    // Check parent's last child (for cards)
                    const parent = target.parentElement;
                    if (parent && parent.children.length > 1) {
                        return parent.children[parent.children.length - 1].innerText.trim();
                    }
                    return 'N/A';
                };

                // Helper: Extract Achievement specifically
                const getAchievement = (card) => {
                    if (!card) return 'N/A';
                    const target = Array.from(card.querySelectorAll('span')).find(s => s.innerText.includes('Achievement'));
                    return target ? target.nextElementSibling?.innerText.trim() : 'N/A';
                };

                // 1. Data Gathering
                const metrics = {
                    totalTarget: findValueByLabel('Total Target'),
                    totalFiles: findValueByLabel('Total Files'),
                    todayProj: findValueByLabel('Today Proj'),
                    remaining: findValueByLabel('Remaining'),
                    mtdColl: findValueByLabel('Till Date Coll'),
                    collFiles: findValueByLabel('Coll Files'),
                    todayColl: findValueByLabel('Collection'),
                    dailyReq: findValueByLabel('Daily Req'),
                    achMtd: findValueByLabel('Ach % (MTD)'),
                    uncollected: findValueByLabel('Uncollected'),
                    achToday: findValueByLabel('Ach % (Today)')
                };

                // Sections
                const partACard = Array.from(dashboard.querySelectorAll('h3')).find(h => h.innerText.includes('Part A'))?.closest('.rounded-2xl');
                const partBCard = Array.from(dashboard.querySelectorAll('h3')).find(h => h.innerText.includes('Part B'))?.closest('.rounded-2xl');

                const summaryPartA = {
                    rpi: partACard?.querySelector('.text-xl.font-black')?.innerText.trim() || 'N/A',
                    target: findValueByLabel('Target Amt', partACard),
                    coll: findValueByLabel('Coll Amt', partACard),
                    ach: getAchievement(partACard)
                };

                const summaryPartB = {
                    rpi: partBCard?.querySelector('.text-xl.font-black')?.innerText.trim() || 'N/A',
                    target: findValueByLabel('Target Amt', partBCard),
                    coll: findValueByLabel('Coll Amt', partBCard),
                    ach: getAchievement(partBCard)
                };

                // 2. Report Generation
                const report = document.createElement('div');
                report.id = 'excel-report-render';
                report.style.cssText = `
                    position: fixed; left: -9999px; top: 0; 
                    width: 900px; padding: 40px; background: #ffffff; 
                    font-family: 'Segoe UI', Arial, sans-serif; color: #1f2937;
                `;

                const tableStyle = 'width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 13px;';
                const headerStyle = 'background-color: #f8fafc; font-weight: bold; border: 1px solid #cbd5e1; padding: 4px 8px; color: #475569; text-align: left;';
                const cellStyle = 'border: 1px solid #cbd5e1; padding: 4px 8px; text-align: left;';
                const mainTitle = 'font-size: 22px; font-weight: 800; color: #1e40af; letter-spacing: -0.5px; border-bottom: 3px solid #1e40af; padding-bottom: 10px; margin-bottom: 5px;';

                let html = `
                    <div style="${mainTitle}">OFFICIAL RECOVERY PERFORMANCE REPORT</div>
                    <div style="margin-bottom: 25px; font-size: 12px; color: #64748b; font-weight: 600;">REPORTING DATE: ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase()}</div>
                    
                    <div style="font-weight: 800; margin-bottom: 12px; font-size: 15px; color: #334155; text-transform: uppercase;">1. Executive Summary Aggregate</div>
                    <table style="${tableStyle}">
                        <tr>
                            <td style="${headerStyle}">TOTAL TARGET (AMT)</td><td style="${cellStyle}; font-weight:700;">${metrics.totalTarget}</td>
                            <td style="${headerStyle}">TOTAL TARGET (FILES)</td><td style="${cellStyle}">${metrics.totalFiles}</td>
                        </tr>
                        <tr>
                            <td style="${headerStyle}">MTD COLLECTION (AMT)</td><td style="${cellStyle}; font-weight:700; color:#059669;">${metrics.mtdColl}</td>
                            <td style="${headerStyle}">MTD COLLECTION (FILES)</td><td style="${cellStyle}; color:#059669;">${metrics.collFiles}</td>
                        </tr>
                        <tr>
                            <td style="${headerStyle}">REMAINING TARGET</td><td style="${cellStyle}; font-weight:700; color:#dc2626;">${metrics.remaining}</td>
                            <td style="${headerStyle}">REQUIRED DAILY COLL</td><td style="${cellStyle}; color:#dc2626;">${metrics.dailyReq}</td>
                        </tr>
                        <tr>
                            <td style="${headerStyle}">MTD ACHIEVEMENT</td><td style="${cellStyle}; font-weight:800; color:#2563eb; background:#f0f9ff;">${metrics.achMtd}</td>
                            <td style="${headerStyle}">TODAY ACHIEVEMENT</td><td style="${cellStyle}; font-weight:800; color:#7c3aed; background:#f5f3ff;">${metrics.achToday}</td>
                        </tr>
                    </table>

                    <div style="font-weight: 800; margin-bottom: 12px; font-size: 15px; color: #334155; text-transform: uppercase;">2. Portfolio Performance Segmentation</div>
                    <table style="${tableStyle}">
                        <tr style="background-color: #1e40af; color: #ffffff;">
                            <th style="padding: 4px 8px; border: 1px solid #1e3a8a;">PORTFOLIO SEGMENT</th>
                            <th style="padding: 4px 8px; border: 1px solid #1e3a8a; text-align: center;">RPI SCORE</th>
                            <th style="padding: 4px 8px; border: 1px solid #1e3a8a; text-align: right;">TARGET</th>
                            <th style="padding: 4px 8px; border: 1px solid #1e3a8a; text-align: right;">COLLECTION</th>
                            <th style="padding: 4px 8px; border: 1px solid #1e3a8a; text-align: center;">ACHIEVEMENT</th>
                        </tr>
                        <tr>
                            <td style="${cellStyle}"><b>PART A</b> (North & Central)</td>
                            <td style="${cellStyle}; text-align: center; font-weight: 700;">${summaryPartA.rpi}</td>
                            <td style="${cellStyle}; text-align: right;">${summaryPartA.target}</td>
                            <td style="${cellStyle}; text-align: right; color: #059669;">${summaryPartA.coll}</td>
                            <td style="${cellStyle}; text-align: center; font-weight: 800; background: #f0fdf4;">${summaryPartA.ach}</td>
                        </tr>
                        <tr>
                            <td style="${cellStyle}"><b>PART B</b> (South & East)</td>
                            <td style="${cellStyle}; text-align: center; font-weight: 700;">${summaryPartB.rpi}</td>
                            <td style="${cellStyle}; text-align: right;">${summaryPartB.target}</td>
                            <td style="${cellStyle}; text-align: right; color: #059669;">${summaryPartB.coll}</td>
                            <td style="${cellStyle}; text-align: center; font-weight: 800; background: #f0fdf4;">${summaryPartB.ach}</td>
                        </tr>
                    </table>
                `;

                // Ranking Table Section
                const rankingTable = dashboard.querySelector('#ranking-table-body')?.closest('table');
                if (rankingTable) {
                    html += `<div style="font-weight: 800; margin-bottom: 12px; font-size: 15px; color: #334155; text-transform: uppercase;">3. Territory Performance Ranking Details</div>`;
                    const clone = rankingTable.cloneNode(true);
                    clone.style.cssText = tableStyle;

                    // Cleanup and formalize
                    clone.querySelectorAll('thead th').forEach(th => {
                        th.style.cssText = headerStyle + 'background: #f1f5f9; position: static; white-space: normal; font-size: 11px;';
                        th.className = '';
                    });
                    clone.querySelectorAll('tbody tr').forEach(tr => {
                        tr.className = '';
                        tr.style.backgroundColor = '';
                    });
                    clone.querySelectorAll('tbody td').forEach(td => {
                        td.style.cssText = cellStyle + 'font-size: 11px; white-space: normal;';
                        td.className = '';
                        // Highlight Total rows
                        if (td.innerText.includes('Total')) {
                            td.parentElement.style.backgroundColor = '#f1f5f9';
                            td.style.fontWeight = 'bold';
                        }
                    });
                    clone.querySelectorAll('.sticky').forEach(el => el.style.position = 'static');

                    html += `<div style="width: 100%; border: 1px solid #cbd5e1;">${clone.outerHTML}</div>`;
                }

                html += `
                    <div style="margin-top: 40px; border-top: 1px solid #e2e8f0; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #94a3b8; font-weight: 600;">
                        <span>GENERATED BY RECOVERY INTELLIGENCE PORTAL V3.0</span>
                        <span>STRICTLY CONFIDENTIAL - INTERNAL DISTRIBUTION</span>
                    </div>
                `;

                report.innerHTML = html;
                document.body.appendChild(report);

                try {
                    const canvas = await html2canvas(report, {
                        scale: 1.5,
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        logging: false
                    });

                    const image = canvas.toDataURL('image/png', 1.0);
                    const link = document.createElement('a');
                    const fileName = `Formal_Recovery_Report_${new Date().toISOString().slice(0, 10)}.png`;
                    link.download = fileName;
                    link.href = image;
                    link.click();

                    UI.showSuccess('Excel-Style Formal Report Ready!');
                } catch (error) {
                    console.error('Report failed:', error);
                    UI.showSuccess('Error in Report Generation.');
                } finally {
                    document.body.removeChild(report);
                    UI.toggleLoader(false);
                }
            },

            getCurrentTerritoryId() {
                const db = Store.get();
                let tId = Auth.currentUser.territoryId;
                if (!tId) {
                    const t = db.territories.find(t => t.name === Auth.currentUser.username || t.officer === Auth.currentUser.username);
                    if (t) tId = t.id;
                }
                return tId;
            }
        };

        const Charts = {
            init() {
                if (typeof ChartDataLabels !== 'undefined') {
                    Chart.register(ChartDataLabels);
                }
            },
            renderLine(id, labels, data) {
                this.init();
                const ctx = document.getElementById(id);
                if (UI.charts[id]) UI.charts[id].destroy();
                UI.charts[id] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Collection', data: data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                align: 'top',
                                backgroundColor: 'rgba(255, 255, 255, 0.8)',
                                borderRadius: 4,
                                color: '#10b981',
                                font: { weight: 'bold', size: 10 },
                                formatter: (val) => val.toLocaleString(),
                                padding: 4
                            }
                        }
                    }
                });
            },
            renderBar(id, labels, data) {
                this.init();
                const ctx = document.getElementById(id);
                if (UI.charts[id]) UI.charts[id].destroy();
                UI.charts[id] = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'Amount', data: data, backgroundColor: ['#94a3b8', '#10b981'], borderRadius: 6 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#475569',
                                font: { weight: 'bold' },
                                formatter: (val) => val.toLocaleString()
                            }
                        }
                    }
                });
            },
            renderDoughnut(id, labels, data) {
                this.init();
                const ctx = document.getElementById(id);
                if (UI.charts[id]) UI.charts[id].destroy();
                UI.charts[id] = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#10b981', '#3b82f6'], borderWidth: 0 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold', size: 11 },
                                formatter: (val, ctx) => {
                                    const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '';
                                    const pct = (val / sum * 100).toFixed(1) + '%';
                                    return val.toLocaleString() + '\n(' + pct + ')';
                                },
                                textAlign: 'center'
                            }
                        }
                    }
                });
            }
        };

        // --- PARTICLE ENGINE ---
        const ParticleEngine = {
            canvas: null, ctx: null, width: 0, height: 0, particles: [],
            init() {
                this.canvas = document.createElement('canvas');
                this.canvas.id = 'particle-canvas';
                this.canvas.style.position = 'fixed';
                this.canvas.style.top = '0';
                this.canvas.style.left = '0';
                this.canvas.style.width = '100%';
                this.canvas.style.height = '100%';
                this.canvas.style.zIndex = '-1';
                this.canvas.style.pointerEvents = 'none';
                document.body.appendChild(this.canvas);
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.createParticles();
                this.animate();
            },
            resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
            },
            createParticles() {
                for (let i = 0; i < 50; i++) {
                    this.particles.push({
                        x: Math.random() * this.width,
                        y: Math.random() * this.height,
                        speed: Math.random() * 0.5 + 0.1,
                        size: Math.random() * 2 + 0.5,
                        opacity: Math.random() * 0.5 + 0.1
                    });
                }
            },
            animate() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.ctx.fillStyle = '#10b981';
                this.particles.forEach(p => {
                    p.y -= p.speed;
                    if (p.y < 0) p.y = this.height;
                    this.ctx.globalAlpha = p.opacity;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                requestAnimationFrame(() => this.animate());
            }
        };

        // Initialize
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const role = UI.currentLoginRole;
            const username = role === 'officer' ? document.getElementById('officer-select').value : document.getElementById('username').value;
            const password = document.getElementById('password').value;
            Auth.login(username, password, role);
        });

        window.onload = async () => {
            await Store.init();
            await Auth.checkSession();
            UI.setLoginTab('officer');
            ParticleEngine.init();
        };

    </script>
</body>

</html>